"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){function c(){var a=Math.ceil(Math.log(n.blocksInARow)/Math.log(u.length));return 0==a&&a++,a}function d(){var a=Math.ceil(Math.log(n.blocksInAColumn)/Math.log(10));return 0==a&&a++,a}function e(a){for(var b=c(),d=a.substr(0,b),e=a.substr(b),f=0,g=0;g<b;g++)f+=u.indexOf(d.charAt(g))*Math.pow(u.length,b-(g+1));var h=e-1;return{file:f,rank:h}}function f(a,b){for(var d=c(),e="",f=d;f>0;f--)e+=u.charAt(Math.floor(a%Math.pow(u.length,f)/Math.pow(u.length,f-1)));return e+=b+1}function g(a,b){var c=a*(n.blockSize+n.marginBetweenBlocksSize)+n.blockSize/2,d=(n.blocksInAColumn-b-1)*(n.blockSize+n.marginBetweenBlocksSize)+n.blockSize/2;return{x:c,y:d}}function h(a,b){var c=Math.floor((a+n.marginBetweenBlocksSize/2)/(n.blockSize+n.marginBetweenBlocksSize)),d=n.blocksInAColumn-Math.floor((b+n.marginBetweenBlocksSize/2)/(n.blockSize+n.marginBetweenBlocksSize))-1;return{file:c,rank:d}}function i(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}function j(a){var b=v.defer();if(!s[a]){if(!w[a]){var c=new Image;c.src=n.piecesFolder+"/"+a+".png",c.onload=function(b){var c=b.target;s[a]=c,w[a].deferreds.forEach(function(a){a.resolve(c)}),delete w[a]},c.onerror=function(b){w[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete w[a]},w[a]={piece:c,deferreds:[]}}return w[a].deferreds.push(b),b.promise}return b.resolve(s[a]),b.promise}function k(e){function f(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||m.width,e=a.canvasSize||a.canvasHeight||d||m.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),n=l/(100*h+3*(h-1)),o=e-2*(c+j),p=o/(100*i+3*(i-1)),q=Math.min(n,p);g=Math.floor(100*q);var r=d-g*h-2*(c+j),s=r/(h-1),t=e-g*i-2*(c+j),u=t/(i-1);k=Math.floor(Math.min(s,u))}else k=a.blocksMargin;var v=(d-2*(c+j)-k*(h-1))/h,w=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(v,w));var x=g*h+k*(h-1),y=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:x,allBlocksHeight:y,boardPaddingWidthSize:(d-x-2*(c+j))/2,boardPaddingHeightSize:(e-y-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type?"linesGrid":a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,chessGame:a.chessGame}}function h(b,e,f){var g=[],h=c(),i=d(),j=e/Math.max(h,i);if("V"==f)for(var k=n.blocksInAColumn;k>0;k--)g.push(k);else for(var l=c(),k=0;k<n.blocksInARow;k++){for(var m="",o=l;o>0;o--)m+=u.charAt(Math.floor(k%Math.pow(u.length,o)/Math.pow(u.length,o-1)));g.push(m)}for(var p="H"==f?n.blocksInARow:n.blocksInAColumn,k=0;k<p;k++){var m=new a.Text(g[k],j+"px sans",n.labelsColor);m.regX=m.getBounds().width/2,m.regY=m.getMeasuredLineHeight()/2;var q=n.borderSize/2+n.shadowSize+("H"==f?n.boardPaddingHeightSize:n.boardPaddingWidthSize),r=n.borderSize+k*(n.blockSize+n.marginBetweenBlocksSize)+n.blockSize/2+n.shadowSize+("H"==f?n.boardPaddingWidthSize:n.boardPaddingHeightSize);m.x="H"==f?r:q,m.y="H"==f?q:r;var s=n.borderSize/2+("H"==f?n.allBlocksHeight:n.allBlocksWidth)+n.borderSize+n.shadowSize+("H"==f?n.boardPaddingHeightSize:n.boardPaddingWidthSize),t=m.clone();"H"==f?t.y=s:t.x=s,b.addChild(m),b.addChild(t)}}function i(a,b){var c;return c="linesGrid"==n.type?n.lightSquaresColor:b%2?a%2?n.darkSquaresColor:n.lightSquaresColor:a%2?n.lightSquaresColor:n.darkSquaresColor}function j(a,b,c){function d(){e.moveTo(n.blockSize/2,n.blockSize/2).beginFill(n.linesColor).drawCircle(n.blockSize/2,n.blockSize/2,2.5*n.gridLinesSize)}var e=a.graphics;e.beginStroke(n.linesColor).setStrokeStyle(n.gridLinesSize),0!==b&&e.moveTo(n.blockSize/2,n.blockSize/2).lineTo(0,n.blockSize/2),b!=n.blocksInARow-1&&e.moveTo(n.blockSize/2,n.blockSize/2).lineTo(n.blockSize,n.blockSize/2),0!==c&&e.moveTo(n.blockSize/2,n.blockSize/2).lineTo(n.blockSize/2,n.blockSize),c!=n.blocksInAColumn-1&&e.moveTo(n.blockSize/2,n.blockSize/2).lineTo(n.blockSize/2,0),n.goGame&&(n.blocksInARow%2!==0&&b==Math.floor(n.blocksInARow/2)&&c==Math.floor(n.blocksInARow/2)&&d(),n.blocksInARow>=9&&n.blocksInARow<13&&(2!=b&&n.blocksInARow-b!=3||2!=c&&n.blocksInARow-c!=3||d()),n.blocksInARow>=13&&(3!=b&&n.blocksInARow-b!=4||3!=c&&n.blocksInARow-c!=4||d()),19==n.blocksInARow&&((3!=b&&n.blocksInARow-b!=4||c!=Math.floor(n.blocksInARow/2))&&(3!=c&&n.blocksInARow-c!=4||b!=Math.floor(n.blocksInARow/2))||d()))}if(!e||!e.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(m=document.getElementById(e.canvasId),n=f(e),m.width=n.canvasWidth,m.height=n.canvasHeight,l=new a.Stage(m),l.scaleX=l.scaleY=l.scale=1,l.regX=n.canvasWidth/2,l.regY=n.canvasHeight/2,l.x=n.canvasWidth/2,l.y=n.canvasHeight/2,l.enableMouseOver(40),l.mouseMoveOutside=!0,l.rotation=0,n.borderSize>0){var k=new a.Container,s=new a.Shape;if(s.graphics.beginStroke(n.borderColor).setStrokeStyle(n.borderSize).drawRect(n.borderSize/2+n.shadowSize+n.boardPaddingWidthSize,n.borderSize/2+n.shadowSize+n.boardPaddingHeightSize,n.allBlocksWidth+n.borderSize,n.allBlocksHeight+n.borderSize),s.shadow=new a.Shadow(n.shadowColor,0,0,15),k.addChild(s),n.coords){var t=new a.Container,v=Math.min(Math.floor(.6*n.borderSize),n.blockSize);h(t,v,"V"),h(t,v,"H"),r.push(t),k.addChild(t)}l.addChild(k)}var w=new a.Container;if(w.regX=n.allBlocksWidth/2,w.regY=n.allBlocksHeight/2,w.x=n.canvasWidth/2,w.y=n.canvasHeight/2,w.scaleX=w.scaleY=w.scale=1,w.name="boardContainer",n.marginBetweenBlocksSize>0){var x=new a.Shape,y=x.graphics;y.beginStroke(n.marginColor).setStrokeStyle(n.marginBetweenBlocksSize);for(var z=0;z<n.blocksInARow-1;z++)y.moveTo(n.blockSize+n.marginBetweenBlocksSize/2+(n.blockSize+n.marginBetweenBlocksSize)*z,0).lineTo(n.blockSize+n.marginBetweenBlocksSize/2+(n.blockSize+n.marginBetweenBlocksSize)*z,n.allBlocksHeight);for(var z=0;z<n.blocksInAColumn-1;z++)y.moveTo(0,n.blockSize+n.marginBetweenBlocksSize/2+(n.blockSize+n.marginBetweenBlocksSize)*z).lineTo(n.allBlocksWidth,n.blockSize+n.marginBetweenBlocksSize/2+(n.blockSize+n.marginBetweenBlocksSize)*z);w.addChild(x)}for(var A=new a.Container,z=0;z<n.blocksInARow*n.blocksInAColumn;z++){var B=z%n.blocksInARow,C=Math.floor(z/n.blocksInARow),D=new a.Shape;D.graphics.beginFill(i(B,C)).drawRect(0,0,n.blockSize,n.blockSize);var E=g(B,C);D.x=E.x,D.y=E.y,D.regY=D.regX=n.blockSize/2,"linesGrid"==n.type&&j(D,B,C),A.addChild(D)}w.addChild(A);var F=new a.Container;r.push(F),this.piecesOnBoard=F,w.addChild(this.piecesOnBoard),l.addChild(w);var G=function(){var c,d,e,f,h,i,j,k,m,s,t,u,v=n.rotationDuration,w=!1,x=!1,y=!1,z=!0,A=!1,B=!1,C=n.squeezeScaleFactor,D=.2*v,E=.6*v,F=0,G=0,H=n.animationOfPieces;return function(n){if(!a.Ticker.getPaused()){if(o&&(o=!1,l.update()),p){if(!w||y)if(z&&(c=C),A&&(c=h/l.scaleX),(z||A)&&(f=0,h=l.scaleX,d=l.scaleX*c-l.scaleX,e=d/D,z=!1,A=!1),Math.abs(f)>=Math.abs(d))l.scaleX=l.scaleY=h*c,w||(w=!0,x=!0,B=!0),y&&(y=!1,w=!1,z=!0,p=0);else{var v=n.delta*e;f+=v,l.scaleX=l.scaleY+=v}if(x){if(B){m=0,s=l.rotation,j=p,i=((j+s)%360+360)%360,k=j/E,F=Math.floor((s+45)%360/90),G=Math.floor((i+45)%360/90);var I=0;j>0?(I=(4-(F-G))%4*-90,0==I&&j>=45&&(I=-360)):j<0&&(I=(4+(F-G))%4*90,0==I&&j<-45&&(I=360)),I+=parseInt(j/360,10)*-360,u=I/E,t=(I%360+360)%360;for(var J=0;J<r.length;J++)for(var K=r[J],L=0;L<K.getNumChildren();L++){var M=K.getChildAt(L);M.elementPreviousRotation=M.rotation}B=!1}if(m>=Math.abs(j)){l.rotation=i;for(var J=0;J<r.length;J++)for(var K=r[J],L=0;L<K.getNumChildren();L++){var M=K.getChildAt(L);M.rotation=(M.elementPreviousRotation+t)%360,delete M.elementPreviousRotation}y=!0,A=!0,F=0,G=0,x=!1}else{var v=n.delta*k%360;m+=Math.abs(v),l.rotation=l.rotation+=v;for(var J=0;J<r.length;J++)for(var K=r[J],L=0;L<K.getNumChildren();L++){var M=K.getChildAt(L);v=n.delta*u,M.rotation+=v}}}o=!0}if(q.length>0){for(var J=q.length-1;J>=0;J--){var N=q[J],O=g(N.destFile,N.destRank),P=O.x-N.piece.x,Q=O.y-N.piece.y;H&&(N.piece.file==b&&N.piece.rank==b||(N.piece.file=b,N.piece.rank=b),q[J].piece.x+=.2*P,q[J].piece.y+=.2*Q),(!H||Math.abs(Q)<=1&&Math.abs(P)<=1)&&(N.piece.x=O.x,N.piece.y=O.y,N.piece.file=N.destFile,N.piece.rank=N.destRank,q.splice(J,1))}o=!0}}}}();a.Ticker.addEventListener("tick",G),a.Ticker.setFPS(40),o=!0}var l,m,n,o=!1,p=0,q=[],r=[],s={},t={},u="ABCDEFGHIJKLMNOPQRSTUVWXYZ",v={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=v.defer();b.type="THEN";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):1==this.status&&c(this.value),b.promise},catch:function(a){var b=v.defer();b.type="CATCH";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):2==this.status&&c(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}},w={};return k.prototype.rotate=function(a){p=a||180},k.prototype.setRotation=function(a){l.rotation=(a%360+360)%360;for(var b=Math.floor((l.rotation+45)%360/90)*-90,c=0;c<r.length;c++)for(var d=r[c],e=0;e<d.getNumChildren();e++){var f=d.getChildAt(e);f.rotation=b%360}o=!0},k.prototype.scale=function(a){m.width=n.canvasWidth*a,m.height=n.canvasHeight*a,l.scaleX=l.scaleY=l.scale=a,l.x=n.canvasWidth*a/2,l.y=n.canvasHeight*a/2,o=!0},k.prototype.setPosition=function(a){var c;q.length>0&&(c=q,q=[]);for(var d=[],e=0;e<n.blocksInARow;e++)d.push([]);for(var e=0;e<this.piecesOnBoard.getNumChildren();e++){var g=this.piecesOnBoard.getChildAt(e);g.rank!=b&&g.file!=b&&(d[g.file][g.rank]=g.label)}for(var h=a.split("/"),i=[],e=0;e<n.blocksInARow;e++)i.push([]);for(var e=0;e<n.blocksInAColumn;e++)for(var j=0,k=0;k<h[e].length;)if(isNaN(h[e][k]))i[j][n.blocksInAColumn-1-e]=h[e][k],j++,k++;else{for(var l=1;l+k<h[e].length&&!isNaN(h[e][k+l]);l++);var m=l,p=h[e].substr(k,m);j+=parseInt(p,10),k+=m}console.log(i);for(var r=[],s=[],e=0;e<n.blocksInARow;e++)for(var k=0;k<n.blocksInAColumn;k++)if(d[e][k]&&i[e][k]&&d[e][k]==i[e][k])for(var l=0;l<this.piecesOnBoard.getNumChildren();l++){var g=this.piecesOnBoard.getChildAt(l);if(g.file==e&&g.rank==k){i[e][k]=b,r.push(g);break}}if(c)for(var e=0;e<n.blocksInARow;e++)for(var k=0;k<n.blocksInAColumn;k++)if(i[e][k])for(var l=0;l<c.length;l++){var t=c[l];t.piece.label==i[e][k]&&t.destFile==e&&t.destRank==k&&(i[e][k]=b,r.push(t.piece),s.push(t))}for(var e=0;e<n.blocksInARow;e++)for(var k=0;k<n.blocksInAColumn;k++)if(i[e][k])for(var l=0;l<this.piecesOnBoard.getNumChildren();l++){var g=this.piecesOnBoard.getChildAt(l);if(i[e][k]==g.label&&r.indexOf(g)==-1){for(var u=Math.pow(g.file-e,2)+Math.pow(g.rank-k,2),v=l+1;v<this.piecesOnBoard.getNumChildren();v++){var w=this.piecesOnBoard.getChildAt(v);if(i[e][k]==w.label&&r.indexOf(w)==-1){var x=0;n.chessGame?w.label.toUpperCase()==n.chessGame.bishopLabel.toUpperCase()?(w.rank+w.file)%2==(e+k)%2&&(g.rank+g.file)%2!=(e+k)%2?g=w:((w.rank+w.file)%2!=(e+k)%2&&(g.rank+g.file)%2!=(e+k)%2||(w.rank+w.file)%2==(e+k)%2&&(g.rank+g.file)%2==(e+k)%2)&&(x=Math.pow(w.file-e,2)+Math.pow(w.rank-k,2)):w.label.toUpperCase()==n.chessGame.rookLabel.toUpperCase()?w.file!=e&&w.rank!=k||g.file==e||g.rank==k?x=Math.pow(w.file-e,2)+Math.pow(w.rank-k,2):g=w:w.label.toUpperCase()==n.chessGame.pawnLabel.toUpperCase()?w.file==e&&g.file!=e?g=w:(w.file==e&&g.file==e||w.file!=e&&g.file!=e)&&(x=Math.pow(w.file-e,2)+Math.pow(w.rank-k,2)):x=Math.pow(w.file-e,2)+Math.pow(w.rank-k,2):x=Math.pow(w.file-e,2)+Math.pow(w.rank-k,2),x&&x<u&&(u=x,g=w)}}i[e][k]=b,r.push(g),s.push({piece:g,destFile:e,destRank:k});break}}for(var e=this.piecesOnBoard.getNumChildren()-1;e>=0;e--){var g=this.piecesOnBoard.getChildAt(e);r.indexOf(g)==-1&&this.piecesOnBoard.removeChildAt(e)}0==s.length?o=!0:q=s;for(var e=0;e<n.blocksInARow;e++)for(var k=0;k<n.blocksInAColumn;k++)if(i[e][k]){var y=this.getNewPiece(i[e][k]);y.then(function(a,b){return function(c){c.x=n.allBlocksWidth/2,c.y=n.allBlocksHeight/2,this.setPieceAtPosition(c,f(a,b))}.bind(this)}.call(this,e,k)).catch(function(a){console.log(a)})}},k.prototype.getPosition=function(){for(var a=[],c=0;c<n.blocksInARow;c++)a.push([]);for(var c=0;c<this.piecesOnBoard.getNumChildren();c++){var d=this.piecesOnBoard.getChildAt(c);d.rank!=b&&d.file!=b&&(a[d.file][d.rank]=d.label)}console.log(a);for(var e="",c=n.blocksInAColumn-1;c>=0;c--){c!=n.blocksInAColumn-1&&(e+="/");for(var f=0,g=0;g<n.blocksInARow;g++)a[g][c]?(f>0&&(e+=f,f=0),e+=a[g][c]):f++;f>0&&(e+=f)}return e},k.prototype.move=function(){if(2==arguments.length&&"string"==typeof arguments[0]&&"string"==typeof arguments[1])return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[];a.forEach(function(a){var c=this.getPieceAtPosition(a[0]);i(c)?c.forEach(function(c){b.push([c,a[1]])}):b.push([c,a[1]])}.bind(this)),this.setPieceAtPosition.apply(this,b)},k.prototype.setPieceAtPosition=function(){if(2==arguments.length&&s[arguments[0].label]&&"string"==typeof arguments[1])return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[];return a.forEach(function(a){var c=a[0],d=a[1];if(!c)return!1;var f=e(d),h=f.file,i=f.rank;if(!this.piecesOnBoard.contains(c)){if(!c.x||!c.y){var j=g(h,i);c.x=j.x,c.y=j.y}this.piecesOnBoard.addChild(c)}for(var k=!1,l=0;l<q.length;l++){var m=q[l];if(m.piece==c){m.destFile=h,m.destRank=i,k=!0;break}}k||b.push({piece:c,destFile:h,destRank:i})}.bind(this)),q=q.concat(b),!0},k.prototype.getPieceAtPosition=function(a){for(var b=e(a),c=b.file,d=b.rank,f=[],g=0;g<this.piecesOnBoard.getNumChildren();g++){var h=this.piecesOnBoard.getChildAt(g);h.file==c&&h.rank==d&&f.push(h)}return 1==f.length?f[0]:f},k.prototype.getNewPiece=function(c){var d=v.defer(),e=j(c);return e.then(function(e){var e=new a.Bitmap(e);e.label=c,e.regX=e.regY=s[c].width/2,e.scaleX=e.scaleY=e.scale=.9*n.blockSize/s[c].width,e.x=b,e.y=b;var g=Math.floor((l.rotation+45)%360/90);e.rotation=g*-90,n.actionsOnPieces&&(e.cursor="pointer",e.hitArea=new a.Shape,e.hitArea.graphics.beginFill("#000").drawRect(0,0,s[c].width,s[c].height),e.addEventListener("rollover",function(b){var c=b.target;c.scaleX=c.scaleY=1.25*c.scale,c.shadow=new a.Shadow(n.shadowColor,3,3,5),o=!0}.bind(this)),e.addEventListener("rollout",function(a){var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,o=!0}.bind(this)),e.addEventListener("mousedown",function(a){var b=a.target,c=l.getChildByName("boardContainer"),d=c.globalToLocal(a.stageX,a.stageY);this.piecesOnBoard.removeChild(b),this.piecesOnBoard.addChild(b),b.startPosition={x:b.x,y:b.y},b.x=d.x,b.y=d.y,o=!0}.bind(this)),e.addEventListener("pressmove",function(c){var d=c.target,e=l.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),g=h(f.x,f.y),i=g.file,j=g.rank;d.x=f.x,d.y=f.y;var k=b;if(i>=0&&i<n.blocksInARow&&j>=0&&j<n.blocksInAColumn&&(k=i+n.blocksInARow*j),k!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=k,k!=b)){if("linesGrid"==n.type){var m=new a.Shape;m.alpha=.8,m.graphics.beginFill(n.highlighterColor).drawCircle((n.blockSize+n.marginBetweenBlocksSize)*(d.currentSquare%n.blocksInARow)+n.blockSize/2,(n.blockSize+n.marginBetweenBlocksSize)*(n.blocksInAColumn-Math.floor(d.currentSquare/n.blocksInARow)-1)+n.blockSize/2,2.5*n.highlighterSize),m.name="blockHighlighter"}else{var m=new a.Shape;m.graphics.beginStroke(n.highlighterColor).setStrokeStyle(n.highlighterSize).drawRect((n.blockSize+n.marginBetweenBlocksSize)*i+n.highlighterSize/2,(n.blockSize+n.marginBetweenBlocksSize)*(n.blocksInAColumn-j-1)+n.highlighterSize/2,n.blockSize-n.highlighterSize,n.blockSize-n.highlighterSize),m.name="blockHighlighter"}n.marginBetweenBlocksSize>0?e.addChildAt(m,2):e.addChildAt(m,1)}o=!0}.bind(this)),e.addEventListener("pressup",function(a){var c=a.target,d=l.getChildByName("boardContainer"),e=d.globalToLocal(a.stageX,a.stageY),g=h(e.x,e.y),i=g.file,j=g.rank;d.removeChild(d.getChildByName("blockHighlighter"));var k=b;if(i>=0&&i<n.blocksInARow&&j>=0&&j<n.blocksInAColumn&&(k=i+n.blocksInARow*j),k){var m=f(c.file,c.rank),p=f(i,j);t.tryMove?t.tryMove(m,p,c)?this.setPieceAtPosition(c,p):(c.x=c.startPosition.x,c.y=c.startPosition.y):this.setPieceAtPosition(c,p)}else c.x=c.startPosition.x,c.y=c.startPosition.y;o=!0}.bind(this))),d.resolve(e)}.bind(this)).catch(function(a){d.reject(a)}),d.promise},k});