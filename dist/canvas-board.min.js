"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){function c(a,b){return Math.ceil(Math.log(a)/Math.log(b))}function d(a){return c(a,r.length)||1}function e(a){return c(a,10)||1}function f(a,b){for(var c=d(b),e=a.substr(0,c),f=a.substr(c),g=0,h=0;h<c;h++)g+=r.indexOf(e.charAt(h))*Math.pow(r.length,c-(h+1));var i=f-1;return{file:g,rank:i}}function g(a,b,c){for(var e=d(c),f="",g=e;g>0;g--)f+=r.charAt(Math.floor(a%Math.pow(r.length,g)/Math.pow(r.length,g-1)));return f+=b+1}function h(a,b,c,d,e){return{x:a*(d+e)+d/2,y:(c-b-1)*(d+e)+d/2}}function i(a,b,c,d,e){return{file:Math.floor((a+e/2)/(d+e)),rank:c-Math.floor((b+e/2)/(d+e))-1}}function j(a,b,c){if("string"!=typeof a)return!1;for(var e=d(b),f=a.substr(0,e),g=0,h=0;h<e;h++){var i=r.indexOf(f.charAt(h));if(i<0)return!1;g+=i*Math.pow(r.length,e-(h+1))}if(g>=b)return!1;var j=a.substr(e);return!(!Number.isInteger(parseInt(j,10))||parseInt(j,10)<1||parseInt(j,10)>c)}function k(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}function l(a,b){return!("object"!=typeof a||!a.label||!b[a.label])}function m(a,c,d){for(var e=[],f=0;f<c;f++){for(var g=[],h=0;h<d;h++)g.push(b);e.push(g)}for(var f=0;f<a.getNumChildren();f++){var i=a.getChildAt(f);i.rank!=b&&i.file!=b&&(e[i.file][i.rank]||(e[i.file][i.rank]=[]),e[i.file][i.rank].push(i.label))}return e}function n(a){if(!k(a))throw new Error("getFenFromBoard: invalid input parameter");for(var c,d=a.length,e=0;e<d;e++){if(!k(a[e]))throw new Error("getFenFromBoard: invalid input parameter");if(0==e)c=a[e].length;else if(c!=a[e].length)throw new Error("getFenFromBoard: invalid input parameter");for(var f=0;f<c;f++)if(a[e][f]!=b&&!k(a[e][f]))throw new Error("getFenFromBoard: invalid input parameter")}if(!c)throw new Error("getFenFromBoard: invalid input parameter");for(var g="",e=c-1;e>=0;e--){e!=c-1&&(g+="/");for(var h=0,f=0;f<d;f++)if(a[f][e]&&a[f][e].length>0)if(h>0&&(g+=h,h=0),1==a[f][e].length)g+=a[f][e][0];else{g+="[";for(var i=0;i<a[f][e].length;i++)g+=a[f][e][i];g+="]"}else h++;h>0&&(g+=h)}return g}function o(a){function c(a){for(var b=0,c=0;c<a.length;)if(isNaN(a[c])){if("["!=a[c])c++;else{for(var d=!1,e=1;e+c<a.length;e++)if("]"==a[c+e]){d=!0;break}if(!d)throw new Error("getBoardFromFen: invalid input parameter");c+=e+1}b++}else{for(var e=1;e+c<a.length&&!isNaN(a[c+e]);e++);var f=e,g=a.substr(c,f);b+=parseInt(g,10),c+=f}return b}for(var d,e=a.split("/"),f=e.length,g=0;g<f;g++)if(0==g)d=c(e[g]);else if(d!=c(e[g]))throw new Error("getBoardFromFen: invalid input parameter");for(var h=[],g=0;g<d;g++){for(var i=[],j=0;j<f;j++)i.push(b);h.push(i)}for(var g=0;g<f;g++)for(var k=0,j=0;j<e[g].length;)if(isNaN(e[g][j])){var l=[];if("["==e[g][j]){for(j++;"]"!=e[g][j];)l.push(e[g][j]),j++;j++}else l.push(e[g][j]),j++;h[k][f-g-1]=l,k++}else{for(var m=1;m+j<e[g].length&&!isNaN(e[g][j+m]);m++);var n=m,o=e[g].substr(j,n);k+=parseInt(o,10),j+=n}return h}function p(a,b,c,d,e){var f=s.defer();if(c[a])f.resolve(c[a]);else{if(!b[a]){var g=new Image;g.src=d+"/"+(e[a]||a)+".png",g.onload=function(d){var e=d.target;c[a]=e,b[a].deferreds.forEach(function(a){a.resolve(e)}),delete b[a]},g.onerror=function(c){b[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete b[a]},b[a]={piece:g,deferreds:[]}}b[a].deferreds.push(f)}return f.promise}function q(c){this.stage,this.canvas,this.configuration,this.selectedPiece,this.piecesContainer,this.loadingPieces={},this.piecesBox={},this.update=!1,this.rotationDegrees=0,this.listOfMovements=[],this.containersToRotate=[],function(){function f(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||this.canvas.width,e=a.canvasSize||a.canvasHeight||d||this.canvas.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(0!=a.blocksMargin&&a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),m=l/(100*h+3*(h-1)),n=e-2*(c+j),o=n/(100*i+3*(i-1)),p=Math.min(m,o);g=Math.floor(100*p);var q=d-g*h-2*(c+j),r=q/(h-1),s=e-g*i-2*(c+j),t=s/(i-1);k=Math.floor(Math.min(r,t))}else k=a.blocksMargin;var u=(d-2*(c+j)-k*(h-1))/h,v=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(u,v));var w=g*h+k*(h-1),x=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:w,allBlocksHeight:x,boardPaddingWidthSize:(d-w-2*(c+j))/2,boardPaddingHeightSize:(e-x-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type||a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",piecesFiles:a.piecesFiles||{},actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,position:a.position,hooks:a.hooks||{},chessGame:a.chessGame||{}}}function j(b,c,f){var g=[],h=d(this.configuration.blocksInARow),i=e(this.configuration.blocksInAColumn),j=c/Math.max(h,i);if("V"==f)for(var k=this.configuration.blocksInAColumn;k>0;k--)g.push(k);else for(var l=d(this.configuration.blocksInARow),k=0;k<this.configuration.blocksInARow;k++){for(var m="",n=l;n>0;n--)m+=r.charAt(Math.floor(k%Math.pow(r.length,n)/Math.pow(r.length,n-1)));g.push(m)}for(var o="H"==f?this.configuration.blocksInARow:this.configuration.blocksInAColumn,k=0;k<o;k++){var m=new a.Text(g[k],j+"px sans",this.configuration.labelsColor);m.regX=m.getBounds().width/2,m.regY=m.getMeasuredLineHeight()/2;var p=this.configuration.borderSize/2+this.configuration.shadowSize+("H"==f?this.configuration.boardPaddingHeightSize:this.configuration.boardPaddingWidthSize),q=this.configuration.borderSize+k*(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)+this.configuration.blockSize/2+this.configuration.shadowSize+("H"==f?this.configuration.boardPaddingWidthSize:this.configuration.boardPaddingHeightSize);m.x="H"==f?q:p,m.y="H"==f?p:q;var s=this.configuration.borderSize/2+("H"==f?this.configuration.allBlocksHeight:this.configuration.allBlocksWidth)+this.configuration.borderSize+this.configuration.shadowSize+("H"==f?this.configuration.boardPaddingHeightSize:this.configuration.boardPaddingWidthSize),t=m.clone();"H"==f?t.y=s:t.x=s,b.addChild(m),b.addChild(t)}}function k(a,b){var c;return c="linesGrid"==this.configuration.type?this.configuration.lightSquaresColor:b%2?a%2?this.configuration.darkSquaresColor:this.configuration.lightSquaresColor:a%2?this.configuration.lightSquaresColor:this.configuration.darkSquaresColor}function l(a,b,c){function d(){e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).beginFill(this.configuration.linesColor).drawCircle(this.configuration.blockSize/2,this.configuration.blockSize/2,2.5*this.configuration.gridLinesSize)}var e=a.graphics;e.beginStroke(this.configuration.linesColor).setStrokeStyle(this.configuration.gridLinesSize),0!==b&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(0,this.configuration.blockSize/2),b!=this.configuration.blocksInARow-1&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize,this.configuration.blockSize/2),0!==c&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize/2,this.configuration.blockSize),c!=this.configuration.blocksInAColumn-1&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize/2,0),this.configuration.goGame&&(this.configuration.blocksInARow%2!==0&&b==Math.floor(this.configuration.blocksInARow/2)&&c==Math.floor(this.configuration.blocksInARow/2)&&d.call(this),this.configuration.blocksInARow>=9&&this.configuration.blocksInARow<13&&(2!=b&&this.configuration.blocksInARow-b!=3||2!=c&&this.configuration.blocksInARow-c!=3||d.call(this)),this.configuration.blocksInARow>=13&&(3!=b&&this.configuration.blocksInARow-b!=4||3!=c&&this.configuration.blocksInARow-c!=4||d.call(this)),this.configuration.blocksInARow>=19&&((3!=b&&this.configuration.blocksInARow-b!=4||c!=Math.floor(this.configuration.blocksInARow/2))&&(3!=c&&this.configuration.blocksInARow-c!=4||b!=Math.floor(this.configuration.blocksInARow/2))||d.call(this)))}if(!c||!c.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(this.canvas=document.getElementById(c.canvasId),this.configuration=f(c),this.canvas.width=this.configuration.canvasWidth,this.canvas.height=this.configuration.canvasHeight,this.stage=new a.Stage(this.canvas),this.stage.scaleX=this.stage.scaleY=this.stage.scale=1,this.stage.regX=this.configuration.canvasWidth/2,this.stage.regY=this.configuration.canvasHeight/2,this.stage.x=this.configuration.canvasWidth/2,this.stage.y=this.configuration.canvasHeight/2,this.stage.enableMouseOver(40),this.stage.mouseMoveOutside=!0,this.stage.rotation=0,this.configuration.borderSize>0){var m=new a.Container,n=new a.Shape;if(n.graphics.beginStroke(this.configuration.borderColor).setStrokeStyle(this.configuration.borderSize).drawRect(this.configuration.borderSize/2+this.configuration.shadowSize+this.configuration.boardPaddingWidthSize,this.configuration.borderSize/2+this.configuration.shadowSize+this.configuration.boardPaddingHeightSize,this.configuration.allBlocksWidth+this.configuration.borderSize,this.configuration.allBlocksHeight+this.configuration.borderSize),n.shadow=new a.Shadow(this.configuration.shadowColor,0,0,15),m.addChild(n),this.configuration.coords){var o=new a.Container,p=Math.min(Math.floor(.6*this.configuration.borderSize),this.configuration.blockSize);j.call(this,o,p,"V"),j.call(this,o,p,"H"),this.containersToRotate.push(o),m.addChild(o)}this.stage.addChild(m)}var q=new a.Container;if(q.regX=this.configuration.allBlocksWidth/2,q.regY=this.configuration.allBlocksHeight/2,q.x=this.configuration.canvasWidth/2,q.y=this.configuration.canvasHeight/2,q.scaleX=q.scaleY=q.scale=1,q.name="boardContainer",this.configuration.marginBetweenBlocksSize>0){var s=new a.Shape,t=s.graphics;t.beginStroke(this.configuration.marginColor).setStrokeStyle(this.configuration.marginBetweenBlocksSize);for(var u=0;u<this.configuration.blocksInARow-1;u++)t.moveTo(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*u,0).lineTo(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*u,this.configuration.allBlocksHeight);for(var u=0;u<this.configuration.blocksInAColumn-1;u++)t.moveTo(0,this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*u).lineTo(this.configuration.allBlocksWidth,this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*u);q.addChild(s)}for(var v=new a.Container,u=0;u<this.configuration.blocksInARow*this.configuration.blocksInAColumn;u++){var w=u%this.configuration.blocksInARow,x=Math.floor(u/this.configuration.blocksInARow),y=new a.Shape;y.graphics.beginFill(k.call(this,w,x)).drawRect(0,0,this.configuration.blockSize,this.configuration.blockSize);var z=h(w,x,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize);y.x=z.x,y.y=z.y,y.regY=y.regX=this.configuration.blockSize/2,this.configuration.actionsOnPieces&&(y.addEventListener("rollover",function(b){if(this.selectedPiece){q.removeChild(q.getChildByName("blockHighlighter"));var c=q.globalToLocal(b.stageX,b.stageY);c.x<0&&(c.x=0),c.y<0&&(c.y=0);var d=i(c.x,c.y,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),e=new a.Shape;e.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*d.file+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-d.rank-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),e.name="blockHighlighter",q.addChildAt(e,q.getNumChildren()-1),this.update=!0}}.bind(this)),y.addEventListener("rollout",function(a){this.selectedPiece&&(q.removeChild(q.getChildByName("blockHighlighter")),this.update=!0)}.bind(this)),y.addEventListener("pressup",function(a){if(this.selectedPiece){q.removeChild(q.getChildByName("blockHighlighter"));var c=q.globalToLocal(a.stageX,a.stageY),d=i(c.x,c.y,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),e=g(d.file,d.rank,this.configuration.blocksInARow),f=this.move(this.selectedPiece,e);f||(this.selectedPiece.x=this.selectedPiece.startPosition.x,this.selectedPiece.y=this.selectedPiece.startPosition.y),this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b,this.update=!0}}.bind(this))),"linesGrid"==this.configuration.type&&l.call(this,y,w,x),v.addChild(y)}q.addChild(v),this.piecesContainer=new a.Container,this.containersToRotate.push(this.piecesContainer),q.addChild(this.piecesContainer),this.stage.addChild(q),a.Ticker.addEventListener("tick",function(){var b,c,d,e,f,g,i,j,k,l,m,n,o,p,q=!1,r=!1,s=!1,t=!0,u=!1,v=!1,w=.2*this.configuration.rotationDuration,x=.6*this.configuration.rotationDuration;return function(y){if(!a.Ticker.getPaused()){if(this.update&&(this.update=!1,this.stage.update()),this.rotationDegrees){if(!q||s)if(t&&(b=this.configuration.squeezeScaleFactor),u&&(b=f/this.stage.scaleX),(t||u)&&(e=0,f=this.stage.scaleX,c=this.stage.scaleX*b-this.stage.scaleX,d=c/w,t=!1,u=!1),Math.abs(e)>=Math.abs(c))this.stage.scaleX=this.stage.scaleY=f*b,q||(q=!0,r=!0,v=!0),s&&(s=!1,q=!1,t=!0,this.rotationDegrees=0);else{var z=y.delta*d;e+=z,this.stage.scaleX=this.stage.scaleY+=z}if(r){if(v){k=0,l=this.stage.rotation,i=this.rotationDegrees,g=((i+l)%360+360)%360,j=i/x,m=Math.floor((l+45)%360/90),n=Math.floor((g+45)%360/90);var A=0;i>0?(A=(4-(m-n))%4*-90,0==A&&i>=90&&(A=-360)):i<0&&(A=(4+(m-n))%4*90,0==A&&i<-90&&(A=360)),A+=parseInt(i/360,10)*-360,p=A/x,o=(A%360+360)%360;for(var B=0;B<this.containersToRotate.length;B++)for(var C=this.containersToRotate[B],D=0;D<C.getNumChildren();D++){var E=C.getChildAt(D);E.elementPreviousRotation=E.rotation}v=!1}if(k>=Math.abs(i)){this.stage.rotation=g;for(var B=0;B<this.containersToRotate.length;B++)for(var C=this.containersToRotate[B],D=0;D<C.getNumChildren();D++){var E=C.getChildAt(D);E.rotation=(E.elementPreviousRotation+o)%360,delete E.elementPreviousRotation}s=!0,u=!0,m=0,n=0,r=!1}else{var z=y.delta*j%360;k+=Math.abs(z),this.stage.rotation+=z;for(var B=0;B<this.containersToRotate.length;B++)for(var C=this.containersToRotate[B],D=0;D<C.getNumChildren();D++){var E=C.getChildAt(D);z=y.delta*p,E.rotation+=z}}}this.update=!0}if(this.listOfMovements.length>0){for(var B=this.listOfMovements.length-1;B>=0;B--){var F=this.listOfMovements[B],G=h(F.destFile,F.destRank,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),H=G.x-F.piece.x,I=G.y-F.piece.y;this.configuration.animationOfPieces&&(this.listOfMovements[B].piece.x+=.2*H,this.listOfMovements[B].piece.y+=.2*I),(!this.configuration.animationOfPieces||Math.abs(I)<=1&&Math.abs(H)<=1)&&(F.piece.x=G.x,F.piece.y=G.y,this.listOfMovements.splice(B,1))}this.update=!0}}}.bind(this)}.bind(this)()),a.Ticker.setFPS(40),this.update=!0,this.configuration.position&&this.setPosition(this.configuration.position)}.bind(this)()}if(!a)throw new Error("Fatal error: createjs not imported.");var r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=s.defer();b.type="THEN";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):1==this.status&&c(this.value),b.promise},catch:function(a){var b=s.defer();b.type="CATCH";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):2==this.status&&c(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}};return q.prototype.rotate=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("rotate: passed value is not an integer.");this.rotationDegrees=a||180},q.prototype.setRotation=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("setRotation: passed value is not an integer.");a=a||0,this.stage.rotation=(a%360+360)%360;for(var c=Math.floor((this.stage.rotation+45)%360/90)*-90,d=0;d<this.containersToRotate.length;d++)for(var e=this.containersToRotate[d],f=0;f<e.getNumChildren();f++){var g=e.getChildAt(f);g.rotation=c%360}this.update=!0},q.prototype.scale=function(a){if(a===b||isNaN(a)||a<0)throw new Error("scale: invalid scale parameter.");this.canvas.width=this.configuration.canvasWidth*a,this.canvas.height=this.configuration.canvasHeight*a,this.stage.scaleX=this.stage.scaleY=this.stage.scale=a,this.stage.x=this.configuration.canvasWidth*a/2,this.stage.y=this.configuration.canvasHeight*a/2,this.update=!0},q.prototype.setPosition=function(a){if(a==b||""==a){a="";for(var c=0;c<this.configuration.blocksInAColumn;c++)a.length>0&&(a+="/"),a+=this.configuration.blocksInARow}var d=m(this.piecesContainer,this.configuration.blocksInARow,this.configuration.blocksInAColumn),e=o(a);if(e.length!=this.configuration.blocksInARow||e[0].length!=this.configuration.blocksInAColumn)throw new Error("setPosition: invalid input parameter.");for(var f=[],h=[],c=0;c<this.configuration.blocksInARow;c++)for(var i=0;i<this.configuration.blocksInAColumn;i++)if(d[c][i]&&e[c][i])for(var j=0;j<this.piecesContainer.getNumChildren();j++){var k=this.piecesContainer.getChildAt(j);if(k.file==c&&k.rank==i){var l=e[c][i].indexOf(k.label);if(l!=-1&&d[c][i].indexOf(k.label)!=-1){if(f.push(k),1==e[c][i].length){e[c][i]=b;break}e[c][i].splice(l,1)}}}for(var c=0;c<this.configuration.blocksInARow;c++)for(var i=0;i<this.configuration.blocksInAColumn;i++)if(e[c][i])for(var j=0;j<this.piecesContainer.getNumChildren();j++){var k=this.piecesContainer.getChildAt(j);if(f.indexOf(k)==-1){var l=e[c][i].indexOf(k.label);if(l!=-1){for(var n=Math.pow(k.file-c,2)+Math.pow(k.rank-i,2),p=j+1;p<this.piecesContainer.getNumChildren();p++){var q=this.piecesContainer.getChildAt(p);if(e[c][i].indexOf(q.label)!=-1&&f.indexOf(q)==-1){var r=0;this.configuration.chessGame.bishopLabel&&q.label.toUpperCase()==this.configuration.chessGame.bishopLabel.toUpperCase()?(q.rank+q.file)%2==(c+i)%2&&(k.rank+k.file)%2!=(c+i)%2?k=q:((q.rank+q.file)%2!=(c+i)%2&&(k.rank+k.file)%2!=(c+i)%2||(q.rank+q.file)%2==(c+i)%2&&(k.rank+k.file)%2==(c+i)%2)&&(r=Math.pow(q.file-c,2)+Math.pow(q.rank-i,2)):this.configuration.chessGame.rookLabel&&q.label.toUpperCase()==this.configuration.chessGame.rookLabel.toUpperCase()?q.file!=c&&q.rank!=i||k.file==c||k.rank==i?r=Math.pow(q.file-c,2)+Math.pow(q.rank-i,2):k=q:this.configuration.chessGame.pawnLabel&&q.label.toUpperCase()==this.configuration.chessGame.pawnLabel.toUpperCase()?q.file==c&&k.file!=c?k=q:(q.file==c&&k.file==c||q.file!=c&&k.file!=c)&&(r=Math.pow(q.file-c,2)+Math.pow(q.rank-i,2)):r=Math.pow(q.file-c,2)+Math.pow(q.rank-i,2),r&&r<n&&(n=r,k=q)}}if(f.push(k),h.push([k,g(c,i,this.configuration.blocksInARow)]),1==e[c][i].length){e[c][i]=b;break}e[c][i].splice(l,1)}}}for(var c=this.piecesContainer.getNumChildren()-1;c>=0;c--){var k=this.piecesContainer.getChildAt(c);f.indexOf(k)==-1&&this.removePiece(k)}var s,t;0==this.piecesContainer.getNumChildren()&&this.configuration.animationOfPieces&&(s=this.configuration.allBlocksWidth/2,t=this.configuration.allBlocksHeight/2);for(var c=0;c<this.configuration.blocksInARow;c++)for(var i=0;i<this.configuration.blocksInAColumn;i++)if(e[c][i])for(var j=0;j<e[c][i].length;j++){var u=this.getNewPiece(e[c][i][j]);u.then(function(a,b,c){c.x=s,c.y=t,this.setPieceAtPosition(c,g(a,b,this.configuration.blocksInARow))}.bind(this,c,i)).catch(function(a){console.log(a)})}this.setPieceAtPosition.apply(this,h)},q.prototype.getPosition=function(){return n(m(this.piecesContainer,this.configuration.blocksInARow,this.configuration.blocksInAColumn))},q.prototype.move=function(){if(2==arguments.length&&(j(arguments[0],this.configuration.blocksInARow,this.configuration.blocksInAColumn)||l(arguments[0],this.piecesBox))&&j(arguments[1],this.configuration.blocksInARow,this.configuration.blocksInAColumn))return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),c=[];a.forEach(function(a){if(a){var d,e;if(l(a[0],this.piecesBox))e=g(a[0].file,a[0].rank,this.configuration.blocksInARow),d=[a[0]];else{if(!j(a[0],this.configuration.blocksInARow,this.configuration.blocksInAColumn))return;if(e=a[0],d=this.getPieceAtPosition(e),!d)return;k(d)||(d=[d])}if(j(a[1],this.configuration.blocksInARow,this.configuration.blocksInAColumn)){var f=this.getPieceAtPosition(a[1]);f?k(f)||(f=[f]):f=[],d.forEach(function(d){if(this.configuration.hooks.isValidMove){var g=this.configuration.hooks.isValidMove.call(this,e,a[1],d,f);if(1==g)c.push([e,a[1],d,f]);else if(0!=g&&g!=b)throw new Error(".isValidMove: invalid hook function.")}else c.push([e,a[1],d,f])}.bind(this))}}}.bind(this));var d=!1;return c.forEach(function(a){var b;this.configuration.hooks.preMove&&(b=this.configuration.hooks.preMove.call(this,a[0],a[1],a[2],a[3])),this.piecesContainer.removeChild(a[2]),this.piecesContainer.addChild(a[2]);var c=this.setPieceAtPosition(a[2],a[1]);this.configuration.hooks.postMove&&this.configuration.hooks.postMove.call(this,a[0],a[1],a[2],a[3],b,c),d=c||d}.bind(this)),d},q.prototype.setPieceAtPosition=function(){if(2==arguments.length&&l(arguments[0],this.piecesBox)&&j(arguments[1],this.configuration.blocksInARow,this.configuration.blocksInAColumn))return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[],c=!1;return a.forEach(function(a){if(l(a[0],this.piecesBox)&&j(a[1],this.configuration.blocksInARow,this.configuration.blocksInAColumn)){var d=a[0],e=a[1],g=f(e,this.configuration.blocksInARow),i=g.file,k=g.rank;if(!this.piecesContainer.contains(d)){if(!d.x||!d.y){var m=h(i,k,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize);d.x=m.x,d.y=m.y}this.piecesContainer.addChild(d)}for(var n=!1,o=0;o<this.listOfMovements.length;o++){var p=this.listOfMovements[o];if(p.piece==d){p.destFile=i,p.destRank=k,n=!0;break}}n||b.push({piece:d,destFile:i,destRank:k}),d.file=i,d.rank=k,c=!0}}.bind(this)),!!c&&(this.listOfMovements=this.listOfMovements.concat(b),!0)},q.prototype.getPieceAtPosition=function(a){if(!j(a,this.configuration.blocksInARow,this.configuration.blocksInAColumn))throw new Error("getPieceAtPosition: invalid position.");for(var c=f(a,this.configuration.blocksInARow),d=c.file,e=c.rank,g=[],h=this.piecesContainer.getNumChildren()-1;h>=0;h--){var i=this.piecesContainer.getChildAt(h);i.file==d&&i.rank==e&&g.push(i)}return 0==g.length?b:1==g.length?g[0]:g},q.prototype.removePieceFromPosition=function(a){if(!j(a,this.configuration.blocksInARow,this.configuration.blocksInAColumn))throw new Error("removePieceFromPosition: invalid position.");var b=this.getPieceAtPosition(a);return!!b&&(k(b)||(b=[b]),b.forEach(function(a){this.piecesContainer.removeChild(a)}.bind(this)),this.update=!0,!0)},q.prototype.removePiece=function(a){if(!l(a,this.piecesBox))throw new Error("removePiece: invalid input parameter.");return!!this.piecesContainer.contains(a)&&(this.piecesContainer.removeChild(a),this.update=!0,!0)},q.prototype.getNewPiece=function(c){var d=s.defer(),e=p(c,this.loadingPieces,this.piecesBox,this.configuration.piecesFolder,this.configuration.piecesFiles);return e.then(function(e){var e=new a.Bitmap(e);e.label=c,e.regX=e.regY=this.piecesBox[c].width/2,e.scaleX=e.scaleY=e.scale=.9*this.configuration.blockSize/this.piecesBox[c].width,e.x=b,e.y=b;var f=Math.floor((this.stage.rotation+45)%360/90);e.rotation=f*-90,this.configuration.actionsOnPieces&&(e.cursor="pointer",e.hitArea=new a.Shape,e.hitArea.graphics.beginFill("#000").drawRect(0,0,this.piecesBox[c].width,this.piecesBox[c].height),e.addEventListener("rollover",function(b){if(this.selectedPiece){this.stage.getChildByName("boardContainer").removeChild(this.stage.getChildByName("boardContainer").getChildByName("blockHighlighter"));var c=this.stage.getChildByName("boardContainer").globalToLocal(b.stageX,b.stageY),d=i(c.x,c.y,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),e=new a.Shape;e.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*d.file+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-d.rank-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),e.name="blockHighlighter",this.stage.getChildByName("boardContainer").addChildAt(e,this.stage.getChildByName("boardContainer").getNumChildren()-1),this.update=!0}else{var f=b.target;f.scaleX=f.scaleY=1.25*f.scale,f.shadow=new a.Shadow(this.configuration.shadowColor,3,3,5),this.update=!0}}.bind(this)),e.addEventListener("rollout",function(a){if(this.selectedPiece)this.stage.getChildByName("boardContainer").removeChild(this.stage.getChildByName("boardContainer").getChildByName("blockHighlighter")),this.update=!0;else{var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,this.update=!0}}.bind(this)),e.addEventListener("mousedown",function(a){for(var c=a.target,d=0;d<this.listOfMovements.length;d++)if(this.listOfMovements[d].piece==c){this.listOfMovements.splice(d,1);break}var e={};if(c.file!=b&&c.rank!=b&&(e=h(c.file,c.rank,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize)),c.startPosition={x:e.x||c.x,y:e.y||c.y},!this.selectedPiece){var f=this.stage.getChildByName("boardContainer"),g=f.globalToLocal(a.stageX,a.stageY);this.piecesContainer.removeChild(c),this.piecesContainer.addChild(c),c.x=g.x,c.y=g.y,this.update=!0}}.bind(this)),e.addEventListener("pressmove",function(c){var d=c.target,e=this.stage.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY);this.selectedPiece&&(e.removeChild(e.getChildByName("blockHighlighter")),this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b,d.scaleX=d.scaleY=1.25*d.scale,d.shadow=new a.Shadow(this.configuration.shadowColor,3,3,5),this.piecesContainer.removeChild(d),this.piecesContainer.addChild(d),d.x=f.x,d.y=f.y,this.update=!0);var g=i(f.x,f.y,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),h=g.file,j=g.rank;d.x=f.x,d.y=f.y;var k=b;if(h>=0&&h<this.configuration.blocksInARow&&j>=0&&j<this.configuration.blocksInAColumn&&(k=h+this.configuration.blocksInARow*j),k!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=k,k!=b)){if("linesGrid"==this.configuration.type){var l=new a.Shape;l.alpha=.8,l.graphics.beginFill(this.configuration.highlighterColor).drawCircle((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(d.currentSquare%this.configuration.blocksInARow)+this.configuration.blockSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-Math.floor(d.currentSquare/this.configuration.blocksInARow)-1)+this.configuration.blockSize/2,2.5*this.configuration.highlighterSize),l.name="blockHighlighter"}else{var l=new a.Shape;l.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*h+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-j-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),l.name="blockHighlighter"}e.addChildAt(l,e.getNumChildren()-1)}this.update=!0}.bind(this)),e.addEventListener("pressup",function(c){var d=c.target,e=this.stage.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),h=i(f.x,f.y,this.configuration.blocksInAColumn,this.configuration.blockSize,this.configuration.marginBetweenBlocksSize),j=h.file,k=h.rank;e.removeChild(e.getChildByName("blockHighlighter"));var l=b;if(j>=0&&j<this.configuration.blocksInARow&&k>=0&&k<this.configuration.blocksInAColumn&&(l=j+this.configuration.blocksInARow*k),l==b)d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0;else if(l!=d.file+this.configuration.blocksInARow*d.rank){var m=g(j,k,this.configuration.blocksInARow),n=this.move(d,m);n||(d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0)}else{if(this.selectedPiece){if(d!=this.selectedPiece){var m=g(j,k,this.configuration.blocksInARow),n=this.move(this.selectedPiece,m);n||(this.selectedPiece.x=this.selectedPiece.startPosition.x,this.selectedPiece.y=this.selectedPiece.startPosition.y)}this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b}else{this.selectedPiece=d;var o=new a.Shape;o.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*j+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-k-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),o.name="blockHighlighter",e.addChildAt(o,e.getNumChildren()-1)}d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0}}.bind(this))),
d.resolve(e)}.bind(this)).catch(function(a){d.reject(a)}),d.promise},q});