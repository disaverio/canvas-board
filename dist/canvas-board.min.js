"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){var c={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=c.defer();b.type="THEN";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):1==this.status&&d(this.value),b.promise},catch:function(a){var b=c.defer();b.type="CATCH";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):2==this.status&&d(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}};return function(d){function e(){var a=Math.ceil(Math.log(o.blocksInARow)/Math.log(x.length));return 0==a&&a++,a}function f(){var a=Math.ceil(Math.log(o.blocksInAColumn)/Math.log(10));return 0==a&&a++,a}function g(a){for(var b=e(),c=a.substr(0,b),d=a.substr(b),f=0,g=0;g<b;g++)f+=x.indexOf(c.charAt(g))*Math.pow(x.length,b-(g+1));var h=d-1;return{file:f,rank:h}}function h(a,b){for(var c=e(),d="",f=c;f>0;f--)d+=x.charAt(Math.floor(a%Math.pow(x.length,f)/Math.pow(x.length,f-1)));return d+=b+1}function i(a,b){var c=a*(o.blockSize+o.marginBetweenBlocksSize)+o.blockSize/2,d=(o.blocksInAColumn-b-1)*(o.blockSize+o.marginBetweenBlocksSize)+o.blockSize/2;return{x:c,y:d}}function j(a,b){var c=Math.floor((a+o.marginBetweenBlocksSize/2)/(o.blockSize+o.marginBetweenBlocksSize)),d=o.blocksInAColumn-Math.floor((b+o.marginBetweenBlocksSize/2)/(o.blockSize+o.marginBetweenBlocksSize))-1;return{file:c,rank:d}}function k(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}function l(a){var b=c.defer();if(!u[a]){if(!w[a]){var d=new Image;d.src=o.piecesFolder+"/"+a+".png",d.onload=function(b){var c=b.target;u[a]=c,w[a].deferreds.forEach(function(a){a.resolve(c)}),delete w[a]},d.onerror=function(b){w[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete w[a]},w[a]={piece:d,deferreds:[]}}return w[a].deferreds.push(b),b.promise}return b.resolve(u[a]),b.promise}var m,n,o,p,q=!1,r=0,s=[],t=[],u={},v={},w={},x="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.rotate=function(a){if(!Number.isInteger(a))throw new Error("Passed value is not an integer.");r=a||180},this.setRotation=function(a){if(!Number.isInteger(a))throw new Error("Passed value is not an integer.");a=a||0,m.rotation=(a%360+360)%360;for(var b=Math.floor((m.rotation+45)%360/90)*-90,c=0;c<t.length;c++)for(var d=t[c],e=0;e<d.getNumChildren();e++){var f=d.getChildAt(e);f.rotation=b%360}q=!0},this.scale=function(a){if(isNaN(a))throw new Error("Passed value is not a number.");if(a===b)throw new Error("No scale factor passed as parameter.");n.width=o.canvasWidth*a,n.height=o.canvasHeight*a,m.scaleX=m.scaleY=m.scale=a,m.x=o.canvasWidth*a/2,m.y=o.canvasHeight*a/2,q=!0},this.setPosition=function(a){if(!a){a="";for(var c=0;c<o.blocksInAColumn;c++)a.length>0&&(a+="/"),a+=o.blocksInARow}var d;s.length>0&&(d=s,s=[]);for(var e=[],c=0;c<o.blocksInARow;c++)e.push([]);for(var c=0;c<p.getNumChildren();c++){var f=p.getChildAt(c);f.rank!=b&&f.file!=b&&(e[f.file][f.rank]=f.label)}for(var g=a.split("/"),i=[],c=0;c<o.blocksInARow;c++)i.push([]);for(var c=0;c<o.blocksInAColumn;c++)for(var j=0,k=0;k<g[c].length;)if(isNaN(g[c][k]))i[j][o.blocksInAColumn-1-c]=g[c][k],j++,k++;else{for(var l=1;l+k<g[c].length&&!isNaN(g[c][k+l]);l++);var m=l,n=g[c].substr(k,m);j+=parseInt(n,10),k+=m}for(var q=[],r=[],c=0;c<o.blocksInARow;c++)for(var k=0;k<o.blocksInAColumn;k++)if(e[c][k]&&i[c][k]&&e[c][k]==i[c][k])for(var l=0;l<p.getNumChildren();l++){var f=p.getChildAt(l);if(f.file==c&&f.rank==k){i[c][k]=b,q.push(f);break}}if(d)for(var c=0;c<o.blocksInARow;c++)for(var k=0;k<o.blocksInAColumn;k++)if(i[c][k])for(var l=0;l<d.length;l++){var t=d[l];t.piece.label==i[c][k]&&t.destFile==c&&t.destRank==k&&(i[c][k]=b,q.push(t.piece),r.push(t))}for(var c=0;c<o.blocksInARow;c++)for(var k=0;k<o.blocksInAColumn;k++)if(i[c][k])for(var l=0;l<p.getNumChildren();l++){var f=p.getChildAt(l);if(i[c][k]==f.label&&q.indexOf(f)==-1){for(var u=Math.pow(f.file-c,2)+Math.pow(f.rank-k,2),v=l+1;v<p.getNumChildren();v++){var w=p.getChildAt(v);if(i[c][k]==w.label&&q.indexOf(w)==-1){var x=0;o.chessGame?w.label.toUpperCase()==o.chessGame.bishopLabel.toUpperCase()?(w.rank+w.file)%2==(c+k)%2&&(f.rank+f.file)%2!=(c+k)%2?f=w:((w.rank+w.file)%2!=(c+k)%2&&(f.rank+f.file)%2!=(c+k)%2||(w.rank+w.file)%2==(c+k)%2&&(f.rank+f.file)%2==(c+k)%2)&&(x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2)):w.label.toUpperCase()==o.chessGame.rookLabel.toUpperCase()?w.file!=c&&w.rank!=k||f.file==c||f.rank==k?x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2):f=w:w.label.toUpperCase()==o.chessGame.pawnLabel.toUpperCase()?w.file==c&&f.file!=c?f=w:(w.file==c&&f.file==c||w.file!=c&&f.file!=c)&&(x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2)):x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2):x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2),x&&x<u&&(u=x,f=w)}}i[c][k]=b,q.push(f),r.push({piece:f,destFile:c,destRank:k});break}}for(var c=p.getNumChildren()-1;c>=0;c--){var f=p.getChildAt(c);q.indexOf(f)==-1&&this.removePieceFromPosition(h(f.file,f.rank))}for(var c=0;c<o.blocksInARow;c++)for(var k=0;k<o.blocksInAColumn;k++)if(i[c][k]){var y=this.getNewPiece(i[c][k]);y.then(function(a,b){var c,d;return 0==p.getNumChildren()&&o.animationOfPieces&&(c=o.allBlocksWidth/2,d=o.allBlocksHeight/2),function(e){e.x=c,e.y=d,this.setPieceAtPosition(e,h(a,b))}.bind(this)}.call(this,c,k)).catch(function(a){console.log(a)})}r.length>0&&(s=r)},this.getPosition=function(){for(var a=[],c=0;c<o.blocksInARow;c++)a.push([]);for(var c=0;c<p.getNumChildren();c++){var d=p.getChildAt(c);d.rank!=b&&d.file!=b&&(a[d.file][d.rank]=d.label)}console.log(a);for(var e="",c=o.blocksInAColumn-1;c>=0;c--){c!=o.blocksInAColumn-1&&(e+="/");for(var f=0,g=0;g<o.blocksInARow;g++)a[g][c]?(f>0&&(e+=f,f=0),e+=a[g][c]):f++;f>0&&(e+=f)}return e},this.move=function(){if(2==arguments.length&&"string"==typeof arguments[0]&&"string"==typeof arguments[1])return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[];return a.forEach(function(a){var c=this.getPieceAtPosition(a[0]);c&&(k(c)?c.forEach(function(c){b.push([c,a[1]])}):b.push([c,a[1]]))}.bind(this)),this.setPieceAtPosition.apply(this,b)},this.setPieceAtPosition=function(){if(2==arguments.length&&u[arguments[0].label]&&"string"==typeof arguments[1])return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[],c=!1;return a.forEach(function(a){var d=a[0],e=a[1];if(!d)return!1;var f=g(e),h=f.file,j=f.rank;if(!(h<0||h>o.blocksInARow||j<0||j>o.blocksInAColumn)){if(!p.contains(d)){if(!d.x||!d.y){var k=i(h,j);d.x=k.x,d.y=k.y}p.addChild(d)}for(var l=!1,m=0;m<s.length;m++){var n=s[m];if(n.piece==d){n.destFile=h,n.destRank=j,l=!0;break}}l||b.push({piece:d,destFile:h,destRank:j}),c=!0}}.bind(this)),!!c&&(s=s.concat(b),!0)},this.getPieceAtPosition=function(a){for(var c=g(a),d=c.file,e=c.rank,f=[],h=p.getNumChildren()-1;h>=0;h--){var i=p.getChildAt(h);i.file==d&&i.rank==e&&(p.removeChild(i),p.addChild(i),f.push(i))}return 0==f.length?b:1==f.length?f[0]:f},this.removePieceFromPosition=function(a){var b=this.getPieceAtPosition(a);return!!b&&(k(b)||(b=[b]),b.forEach(function(a){p.removeChild(a)}.bind(this)),q=!0,!0)},this.getNewPiece=function(d){var e=c.defer(),f=l(d);return f.then(function(c){var c=new a.Bitmap(c);c.label=d,c.regX=c.regY=u[d].width/2,c.scaleX=c.scaleY=c.scale=.9*o.blockSize/u[d].width,c.x=b,c.y=b;var f=Math.floor((m.rotation+45)%360/90);c.rotation=f*-90,o.actionsOnPieces&&(c.cursor="pointer",c.hitArea=new a.Shape,c.hitArea.graphics.beginFill("#000").drawRect(0,0,u[d].width,u[d].height),c.addEventListener("rollover",function(b){var c=b.target;c.scaleX=c.scaleY=1.25*c.scale,c.shadow=new a.Shadow(o.shadowColor,3,3,5),q=!0}.bind(this)),c.addEventListener("rollout",function(a){var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,q=!0}.bind(this)),c.addEventListener("mousedown",function(a){var b=a.target,c=m.getChildByName("boardContainer"),d=c.globalToLocal(a.stageX,a.stageY);p.removeChild(b),p.addChild(b),b.startPosition={x:b.x,y:b.y},b.x=d.x,b.y=d.y,q=!0}.bind(this)),c.addEventListener("pressmove",function(c){var d=c.target,e=m.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),g=j(f.x,f.y),h=g.file,i=g.rank;d.x=f.x,d.y=f.y;var k=b;if(h>=0&&h<o.blocksInARow&&i>=0&&i<o.blocksInAColumn&&(k=h+o.blocksInARow*i),k!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=k,k!=b)){if("linesGrid"==o.type){var l=new a.Shape;l.alpha=.8,l.graphics.beginFill(o.highlighterColor).drawCircle((o.blockSize+o.marginBetweenBlocksSize)*(d.currentSquare%o.blocksInARow)+o.blockSize/2,(o.blockSize+o.marginBetweenBlocksSize)*(o.blocksInAColumn-Math.floor(d.currentSquare/o.blocksInARow)-1)+o.blockSize/2,2.5*o.highlighterSize),l.name="blockHighlighter"}else{var l=new a.Shape;l.graphics.beginStroke(o.highlighterColor).setStrokeStyle(o.highlighterSize).drawRect((o.blockSize+o.marginBetweenBlocksSize)*h+o.highlighterSize/2,(o.blockSize+o.marginBetweenBlocksSize)*(o.blocksInAColumn-i-1)+o.highlighterSize/2,o.blockSize-o.highlighterSize,o.blockSize-o.highlighterSize),l.name="blockHighlighter"}e.addChildAt(l,e.getNumChildren()-1)}q=!0}.bind(this)),c.addEventListener("pressup",function(a){var c=a.target,d=m.getChildByName("boardContainer"),e=d.globalToLocal(a.stageX,a.stageY),f=j(e.x,e.y),g=f.file,i=f.rank;d.removeChild(d.getChildByName("blockHighlighter"));var k=b;if(g>=0&&g<o.blocksInARow&&i>=0&&i<o.blocksInAColumn&&(k=g+o.blocksInARow*i),k){var l=h(c.file,c.rank),n=h(g,i);v.tryMove?v.tryMove(l,n,c)?this.setPieceAtPosition(c,n):(c.x=c.startPosition.x,c.y=c.startPosition.y):this.setPieceAtPosition(c,n)}else c.x=c.startPosition.x,c.y=c.startPosition.y;q=!0}.bind(this))),e.resolve(c)}.bind(this)).catch(function(a){e.reject(a)}),e.promise},function(){function c(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||n.width,e=a.canvasSize||a.canvasHeight||d||n.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(0!=a.blocksMargin&&a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),m=l/(100*h+3*(h-1)),o=e-2*(c+j),p=o/(100*i+3*(i-1)),q=Math.min(m,p);g=Math.floor(100*q);var r=d-g*h-2*(c+j),s=r/(h-1),t=e-g*i-2*(c+j),u=t/(i-1);k=Math.floor(Math.min(s,u))}else k=a.blocksMargin;var v=(d-2*(c+j)-k*(h-1))/h,w=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(v,w));var x=g*h+k*(h-1),y=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:x,allBlocksHeight:y,boardPaddingWidthSize:(d-x-2*(c+j))/2,boardPaddingHeightSize:(e-y-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type?"linesGrid":a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,position:a.position,chessGame:a.chessGame}}function g(b,c,d){var g=[],h=e(),i=f(),j=c/Math.max(h,i);if("V"==d)for(var k=o.blocksInAColumn;k>0;k--)g.push(k);else for(var l=e(),k=0;k<o.blocksInARow;k++){for(var m="",n=l;n>0;n--)m+=x.charAt(Math.floor(k%Math.pow(x.length,n)/Math.pow(x.length,n-1)));g.push(m)}for(var p="H"==d?o.blocksInARow:o.blocksInAColumn,k=0;k<p;k++){var m=new a.Text(g[k],j+"px sans",o.labelsColor);m.regX=m.getBounds().width/2,m.regY=m.getMeasuredLineHeight()/2;var q=o.borderSize/2+o.shadowSize+("H"==d?o.boardPaddingHeightSize:o.boardPaddingWidthSize),r=o.borderSize+k*(o.blockSize+o.marginBetweenBlocksSize)+o.blockSize/2+o.shadowSize+("H"==d?o.boardPaddingWidthSize:o.boardPaddingHeightSize);m.x="H"==d?r:q,m.y="H"==d?q:r;var s=o.borderSize/2+("H"==d?o.allBlocksHeight:o.allBlocksWidth)+o.borderSize+o.shadowSize+("H"==d?o.boardPaddingHeightSize:o.boardPaddingWidthSize),t=m.clone();"H"==d?t.y=s:t.x=s,b.addChild(m),b.addChild(t)}}function h(a,b){var c;return c="linesGrid"==o.type?o.lightSquaresColor:b%2?a%2?o.darkSquaresColor:o.lightSquaresColor:a%2?o.lightSquaresColor:o.darkSquaresColor}function j(a,b,c){function d(){e.moveTo(o.blockSize/2,o.blockSize/2).beginFill(o.linesColor).drawCircle(o.blockSize/2,o.blockSize/2,2.5*o.gridLinesSize)}var e=a.graphics;e.beginStroke(o.linesColor).setStrokeStyle(o.gridLinesSize),0!==b&&e.moveTo(o.blockSize/2,o.blockSize/2).lineTo(0,o.blockSize/2),b!=o.blocksInARow-1&&e.moveTo(o.blockSize/2,o.blockSize/2).lineTo(o.blockSize,o.blockSize/2),0!==c&&e.moveTo(o.blockSize/2,o.blockSize/2).lineTo(o.blockSize/2,o.blockSize),c!=o.blocksInAColumn-1&&e.moveTo(o.blockSize/2,o.blockSize/2).lineTo(o.blockSize/2,0),o.goGame&&(o.blocksInARow%2!==0&&b==Math.floor(o.blocksInARow/2)&&c==Math.floor(o.blocksInARow/2)&&d(),o.blocksInARow>=9&&o.blocksInARow<13&&(2!=b&&o.blocksInARow-b!=3||2!=c&&o.blocksInARow-c!=3||d()),o.blocksInARow>=13&&(3!=b&&o.blocksInARow-b!=4||3!=c&&o.blocksInARow-c!=4||d()),o.blocksInARow>=19&&((3!=b&&o.blocksInARow-b!=4||c!=Math.floor(o.blocksInARow/2))&&(3!=c&&o.blocksInARow-c!=4||b!=Math.floor(o.blocksInARow/2))||d()))}if(!d||!d.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(n=document.getElementById(d.canvasId),o=c(d),n.width=o.canvasWidth,n.height=o.canvasHeight,m=new a.Stage(n),m.scaleX=m.scaleY=m.scale=1,m.regX=o.canvasWidth/2,m.regY=o.canvasHeight/2,m.x=o.canvasWidth/2,m.y=o.canvasHeight/2,m.enableMouseOver(40),m.mouseMoveOutside=!0,m.rotation=0,o.borderSize>0){var k=new a.Container,l=new a.Shape;if(l.graphics.beginStroke(o.borderColor).setStrokeStyle(o.borderSize).drawRect(o.borderSize/2+o.shadowSize+o.boardPaddingWidthSize,o.borderSize/2+o.shadowSize+o.boardPaddingHeightSize,o.allBlocksWidth+o.borderSize,o.allBlocksHeight+o.borderSize),l.shadow=new a.Shadow(o.shadowColor,0,0,15),k.addChild(l),o.coords){var u=new a.Container,v=Math.min(Math.floor(.6*o.borderSize),o.blockSize);g(u,v,"V"),g(u,v,"H"),t.push(u),k.addChild(u)}m.addChild(k)}var w=new a.Container;if(w.regX=o.allBlocksWidth/2,w.regY=o.allBlocksHeight/2,w.x=o.canvasWidth/2,w.y=o.canvasHeight/2,w.scaleX=w.scaleY=w.scale=1,w.name="boardContainer",o.marginBetweenBlocksSize>0){var y=new a.Shape,z=y.graphics;z.beginStroke(o.marginColor).setStrokeStyle(o.marginBetweenBlocksSize);for(var A=0;A<o.blocksInARow-1;A++)z.moveTo(o.blockSize+o.marginBetweenBlocksSize/2+(o.blockSize+o.marginBetweenBlocksSize)*A,0).lineTo(o.blockSize+o.marginBetweenBlocksSize/2+(o.blockSize+o.marginBetweenBlocksSize)*A,o.allBlocksHeight);for(var A=0;A<o.blocksInAColumn-1;A++)z.moveTo(0,o.blockSize+o.marginBetweenBlocksSize/2+(o.blockSize+o.marginBetweenBlocksSize)*A).lineTo(o.allBlocksWidth,o.blockSize+o.marginBetweenBlocksSize/2+(o.blockSize+o.marginBetweenBlocksSize)*A);w.addChild(y)}for(var B=new a.Container,A=0;A<o.blocksInARow*o.blocksInAColumn;A++){var C=A%o.blocksInARow,D=Math.floor(A/o.blocksInARow),E=new a.Shape;E.graphics.beginFill(h(C,D)).drawRect(0,0,o.blockSize,o.blockSize);var F=i(C,D);E.x=F.x,E.y=F.y,E.regY=E.regX=o.blockSize/2,"linesGrid"==o.type&&j(E,C,D),B.addChild(E)}w.addChild(B),p=new a.Container,t.push(p),w.addChild(p),m.addChild(w),a.Ticker.addEventListener("tick",function(){var c,d,e,f,g,h,j,k,l,n,p,u,v,w,x=!1,y=!1,z=!1,A=!0,B=!1,C=!1,D=.2*o.rotationDuration,E=.6*o.rotationDuration;return function(F){if(!a.Ticker.getPaused()){if(q&&(q=!1,m.update()),r){if(!x||z)if(A&&(c=o.squeezeScaleFactor),B&&(c=g/m.scaleX),(A||B)&&(f=0,g=m.scaleX,d=m.scaleX*c-m.scaleX,e=d/D,A=!1,B=!1),Math.abs(f)>=Math.abs(d))m.scaleX=m.scaleY=g*c,x||(x=!0,y=!0,C=!0),z&&(z=!1,x=!1,A=!0,r=0);else{var G=F.delta*e;f+=G,m.scaleX=m.scaleY+=G}if(y){if(C){l=0,n=m.rotation,j=r,h=((j+n)%360+360)%360,k=j/E,p=Math.floor((n+45)%360/90),u=Math.floor((h+45)%360/90);var H=0;j>0?(H=(4-(p-u))%4*-90,0==H&&j>=45&&(H=-360)):j<0&&(H=(4+(p-u))%4*90,0==H&&j<-45&&(H=360)),H+=parseInt(j/360,10)*-360,w=H/E,v=(H%360+360)%360;for(var I=0;I<t.length;I++)for(var J=t[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.elementPreviousRotation=L.rotation}C=!1}if(l>=Math.abs(j)){m.rotation=h;for(var I=0;I<t.length;I++)for(var J=t[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.rotation=(L.elementPreviousRotation+v)%360,delete L.elementPreviousRotation}z=!0,B=!0,p=0,u=0,y=!1}else{var G=F.delta*k%360;l+=Math.abs(G),m.rotation=m.rotation+=G;for(var I=0;I<t.length;I++)for(var J=t[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);G=F.delta*w,L.rotation+=G}}}q=!0}if(s.length>0){for(var I=s.length-1;I>=0;I--){var M=s[I],N=i(M.destFile,M.destRank),O=N.x-M.piece.x,P=N.y-M.piece.y;o.animationOfPieces&&(M.piece.file==b&&M.piece.rank==b||(M.piece.file=b,M.piece.rank=b),s[I].piece.x+=.2*O,s[I].piece.y+=.2*P),(!o.animationOfPieces||Math.abs(P)<=1&&Math.abs(O)<=1)&&(M.piece.x=N.x,M.piece.y=N.y,M.piece.file=M.destFile,M.piece.rank=M.destRank,s.splice(I,1))}q=!0}}}}()),a.Ticker.setFPS(40),q=!0,o.position&&this.setPosition(o.position)}.bind(this)()}});