"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){var c={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=c.defer();b.type="THEN";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):1==this.status&&d(this.value),b.promise},catch:function(a){var b=c.defer();b.type="CATCH";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):2==this.status&&d(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}};return function(d){function e(){var a=Math.ceil(Math.log(p.blocksInARow)/Math.log(x.length));return 0==a&&a++,a}function f(){var a=Math.ceil(Math.log(p.blocksInAColumn)/Math.log(10));return 0==a&&a++,a}function g(a){for(var b=e(),c=a.substr(0,b),d=a.substr(b),f=0,g=0;g<b;g++)f+=x.indexOf(c.charAt(g))*Math.pow(x.length,b-(g+1));var h=d-1;return{file:f,rank:h}}function h(a,b){for(var c=e(),d="",f=c;f>0;f--)d+=x.charAt(Math.floor(a%Math.pow(x.length,f)/Math.pow(x.length,f-1)));return d+=b+1}function i(a,b){var c=a*(p.blockSize+p.marginBetweenBlocksSize)+p.blockSize/2,d=(p.blocksInAColumn-b-1)*(p.blockSize+p.marginBetweenBlocksSize)+p.blockSize/2;return{x:c,y:d}}function j(a,b){var c=Math.floor((a+p.marginBetweenBlocksSize/2)/(p.blockSize+p.marginBetweenBlocksSize)),d=p.blocksInAColumn-Math.floor((b+p.marginBetweenBlocksSize/2)/(p.blockSize+p.marginBetweenBlocksSize))-1;return{file:c,rank:d}}function k(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}function l(a){return"object"==typeof a&&a.label}function m(a){var b=c.defer();if(!v[a]){if(!w[a]){var d=new Image;d.src=p.piecesFolder+"/"+a+".png",d.onload=function(b){var c=b.target;v[a]=c,w[a].deferreds.forEach(function(a){a.resolve(c)}),delete w[a]},d.onerror=function(b){w[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete w[a]},w[a]={piece:d,deferreds:[]}}return w[a].deferreds.push(b),b.promise}return b.resolve(v[a]),b.promise}var n,o,p,q,r=!1,s=0,t=[],u=[],v={},w={},x="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.rotate=function(a){if(!Number.isInteger(a))throw new Error("Passed value is not an integer.");s=a||180},this.setRotation=function(a){if(!Number.isInteger(a))throw new Error("Passed value is not an integer.");a=a||0,n.rotation=(a%360+360)%360;for(var b=Math.floor((n.rotation+45)%360/90)*-90,c=0;c<u.length;c++)for(var d=u[c],e=0;e<d.getNumChildren();e++){var f=d.getChildAt(e);f.rotation=b%360}r=!0},this.scale=function(a){if(isNaN(a))throw new Error("Passed value is not a number.");if(a===b)throw new Error("No scale factor passed as parameter.");o.width=p.canvasWidth*a,o.height=p.canvasHeight*a,n.scaleX=n.scaleY=n.scale=a,n.x=p.canvasWidth*a/2,n.y=p.canvasHeight*a/2,r=!0},this.setPosition=function(a){if(!a){a="";for(var c=0;c<p.blocksInAColumn;c++)a.length>0&&(a+="/"),a+=p.blocksInARow}var d;t.length>0&&(d=t,t=[]);for(var e=[],c=0;c<p.blocksInARow;c++)e.push([]);for(var c=0;c<q.getNumChildren();c++){var f=q.getChildAt(c);f.rank!=b&&f.file!=b&&(e[f.file][f.rank]=f.label)}for(var g=a.split("/"),i=[],c=0;c<p.blocksInARow;c++)i.push([]);for(var c=0;c<p.blocksInAColumn;c++)for(var j=0,k=0;k<g[c].length;)if(isNaN(g[c][k]))i[j][p.blocksInAColumn-1-c]=g[c][k],j++,k++;else{for(var l=1;l+k<g[c].length&&!isNaN(g[c][k+l]);l++);var m=l,n=g[c].substr(k,m);j+=parseInt(n,10),k+=m}for(var o=[],r=[],c=0;c<p.blocksInARow;c++)for(var k=0;k<p.blocksInAColumn;k++)if(e[c][k]&&i[c][k]&&e[c][k]==i[c][k])for(var l=0;l<q.getNumChildren();l++){var f=q.getChildAt(l);if(f.file==c&&f.rank==k){i[c][k]=b,o.push(f);break}}if(d)for(var c=0;c<p.blocksInARow;c++)for(var k=0;k<p.blocksInAColumn;k++)if(i[c][k])for(var l=0;l<d.length;l++){var s=d[l];s.piece.label==i[c][k]&&s.destFile==c&&s.destRank==k&&(i[c][k]=b,o.push(s.piece),r.push(s))}for(var c=0;c<p.blocksInARow;c++)for(var k=0;k<p.blocksInAColumn;k++)if(i[c][k])for(var l=0;l<q.getNumChildren();l++){var f=q.getChildAt(l);if(i[c][k]==f.label&&o.indexOf(f)==-1){for(var u=Math.pow(f.file-c,2)+Math.pow(f.rank-k,2),v=l+1;v<q.getNumChildren();v++){var w=q.getChildAt(v);if(i[c][k]==w.label&&o.indexOf(w)==-1){var x=0;p.chessGame?w.label.toUpperCase()==p.chessGame.bishopLabel.toUpperCase()?(w.rank+w.file)%2==(c+k)%2&&(f.rank+f.file)%2!=(c+k)%2?f=w:((w.rank+w.file)%2!=(c+k)%2&&(f.rank+f.file)%2!=(c+k)%2||(w.rank+w.file)%2==(c+k)%2&&(f.rank+f.file)%2==(c+k)%2)&&(x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2)):w.label.toUpperCase()==p.chessGame.rookLabel.toUpperCase()?w.file!=c&&w.rank!=k||f.file==c||f.rank==k?x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2):f=w:w.label.toUpperCase()==p.chessGame.pawnLabel.toUpperCase()?w.file==c&&f.file!=c?f=w:(w.file==c&&f.file==c||w.file!=c&&f.file!=c)&&(x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2)):x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2):x=Math.pow(w.file-c,2)+Math.pow(w.rank-k,2),x&&x<u&&(u=x,f=w)}}i[c][k]=b,o.push(f),r.push({piece:f,destFile:c,destRank:k});break}}for(var c=q.getNumChildren()-1;c>=0;c--){var f=q.getChildAt(c);o.indexOf(f)==-1&&this.removePieceFromPosition(h(f.file,f.rank))}var y,z;0==q.getNumChildren()&&p.animationOfPieces&&(y=p.allBlocksWidth/2,z=p.allBlocksHeight/2);for(var c=0;c<p.blocksInARow;c++)for(var k=0;k<p.blocksInAColumn;k++)if(i[c][k]){var A=this.getNewPiece(i[c][k]);A.then(function(a,b){return function(c){c.x=y,c.y=z,this.setPieceAtPosition(c,h(a,b))}.bind(this)}.call(this,c,k)).catch(function(a){console.log(a)})}r.length>0&&(t=r)},this.getPosition=function(){for(var a=[],c=0;c<p.blocksInARow;c++)a.push([]);for(var c=0;c<q.getNumChildren();c++){var d=q.getChildAt(c);d.rank!=b&&d.file!=b&&(a[d.file][d.rank]=d.label)}for(var e="",c=p.blocksInAColumn-1;c>=0;c--){c!=p.blocksInAColumn-1&&(e+="/");for(var f=0,g=0;g<p.blocksInARow;g++)a[g][c]?(f>0&&(e+=f,f=0),e+=a[g][c]):f++;f>0&&(e+=f)}return e},this.move=function(){if(2==arguments.length&&("string"==typeof arguments[0]||l(arguments[0]))&&"string"==typeof arguments[1])return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[];a.forEach(function(a){var c,d;if(l(a[0]))d=h(a[0].file,a[0].rank),c=[a[0]];else{if(d=a[0],c=this.getPieceAtPosition(d),!c)return;k(c)||(c=[c])}var e=this.getPieceAtPosition(a[1]);e?k(e)||(e=[e]):e=[],c.forEach(function(c){p.hooks.isValidMove?p.hooks.isValidMove(d,a[1],c,e)&&b.push([d,a[1],c,e]):b.push([d,a[1],c,e])})}.bind(this));var c=!1;return b.forEach(function(a){var b;p.hooks.preMove&&(b=p.hooks.preMove(a[0],a[1],a[2],a[3]));var d=this.setPieceAtPosition(a[2],a[1]);p.hooks.postMove&&p.hooks.postMove(b,d,a[0],a[1],a[2],a[3]),c=d||c}.bind(this)),c},this.setPieceAtPosition=function(){if(2==arguments.length&&v[arguments[0].label]&&"string"==typeof arguments[1])return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[],c=!1;return a.forEach(function(a){var d=a[0],e=a[1];if(d){var f=g(e),h=f.file,j=f.rank;if(!(h<0||h>p.blocksInARow||j<0||j>p.blocksInAColumn)){if(!q.contains(d)){if(!d.x||!d.y){var k=i(h,j);d.x=k.x,d.y=k.y}q.addChild(d)}for(var l=!1,m=0;m<t.length;m++){var n=t[m];if(n.piece==d){n.destFile=h,n.destRank=j,l=!0;break}}l||b.push({piece:d,destFile:h,destRank:j}),c=!0}}}.bind(this)),!!c&&(t=t.concat(b),!0)},this.getPieceAtPosition=function(a){for(var c=g(a),d=c.file,e=c.rank,f=[],h=q.getNumChildren()-1;h>=0;h--){var i=q.getChildAt(h);i.file==d&&i.rank==e&&(q.removeChild(i),q.addChild(i),f.push(i))}return 0==f.length?b:1==f.length?f[0]:f},this.removePieceFromPosition=function(a){var b=this.getPieceAtPosition(a);return!!b&&(k(b)||(b=[b]),b.forEach(function(a){q.removeChild(a)}.bind(this)),r=!0,!0)},this.getNewPiece=function(d){var e=c.defer(),f=m(d);return f.then(function(c){var c=new a.Bitmap(c);c.label=d,c.regX=c.regY=v[d].width/2,c.scaleX=c.scaleY=c.scale=.9*p.blockSize/v[d].width,c.x=b,c.y=b;var f=Math.floor((n.rotation+45)%360/90);c.rotation=f*-90,p.actionsOnPieces&&(c.cursor="pointer",c.hitArea=new a.Shape,c.hitArea.graphics.beginFill("#000").drawRect(0,0,v[d].width,v[d].height),c.addEventListener("rollover",function(b){var c=b.target;c.scaleX=c.scaleY=1.25*c.scale,c.shadow=new a.Shadow(p.shadowColor,3,3,5),r=!0}.bind(this)),c.addEventListener("rollout",function(a){var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,r=!0}.bind(this)),c.addEventListener("mousedown",function(a){var b=a.target,c=n.getChildByName("boardContainer"),d=c.globalToLocal(a.stageX,a.stageY);q.removeChild(b),q.addChild(b),b.startPosition={x:b.x,y:b.y},b.x=d.x,b.y=d.y,r=!0}.bind(this)),c.addEventListener("pressmove",function(c){var d=c.target,e=n.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),g=j(f.x,f.y),h=g.file,i=g.rank;d.x=f.x,d.y=f.y;var k=b;if(h>=0&&h<p.blocksInARow&&i>=0&&i<p.blocksInAColumn&&(k=h+p.blocksInARow*i),k!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=k,k!=b)){if("linesGrid"==p.type){var l=new a.Shape;l.alpha=.8,l.graphics.beginFill(p.highlighterColor).drawCircle((p.blockSize+p.marginBetweenBlocksSize)*(d.currentSquare%p.blocksInARow)+p.blockSize/2,(p.blockSize+p.marginBetweenBlocksSize)*(p.blocksInAColumn-Math.floor(d.currentSquare/p.blocksInARow)-1)+p.blockSize/2,2.5*p.highlighterSize),l.name="blockHighlighter"}else{var l=new a.Shape;l.graphics.beginStroke(p.highlighterColor).setStrokeStyle(p.highlighterSize).drawRect((p.blockSize+p.marginBetweenBlocksSize)*h+p.highlighterSize/2,(p.blockSize+p.marginBetweenBlocksSize)*(p.blocksInAColumn-i-1)+p.highlighterSize/2,p.blockSize-p.highlighterSize,p.blockSize-p.highlighterSize),l.name="blockHighlighter"}e.addChildAt(l,e.getNumChildren()-1)}r=!0}.bind(this)),c.addEventListener("pressup",function(a){var b=a.target,c=n.getChildByName("boardContainer"),d=c.globalToLocal(a.stageX,a.stageY),e=j(d.x,d.y),f=e.file,g=e.rank;c.removeChild(c.getChildByName("blockHighlighter"));var i;if(f>=0&&f<p.blocksInARow&&g>=0&&g<p.blocksInAColumn&&(i=f+p.blocksInARow*g),i){var k=(h(b.file,b.rank),h(f,g)),l=this.move(b,k);l||(b.x=b.startPosition.x,b.y=b.startPosition.y,r=!0)}else b.x=b.startPosition.x,b.y=b.startPosition.y}.bind(this))),e.resolve(c)}.bind(this)).catch(function(a){e.reject(a)}),e.promise},function(){function c(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||o.width,e=a.canvasSize||a.canvasHeight||d||o.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(0!=a.blocksMargin&&a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),m=l/(100*h+3*(h-1)),n=e-2*(c+j),p=n/(100*i+3*(i-1)),q=Math.min(m,p);g=Math.floor(100*q);var r=d-g*h-2*(c+j),s=r/(h-1),t=e-g*i-2*(c+j),u=t/(i-1);k=Math.floor(Math.min(s,u))}else k=a.blocksMargin;var v=(d-2*(c+j)-k*(h-1))/h,w=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(v,w));var x=g*h+k*(h-1),y=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:x,allBlocksHeight:y,boardPaddingWidthSize:(d-x-2*(c+j))/2,boardPaddingHeightSize:(e-y-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type?"linesGrid":a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,position:a.position,hooks:a.hooks||{},chessGame:a.chessGame}}function g(b,c,d){var g=[],h=e(),i=f(),j=c/Math.max(h,i);if("V"==d)for(var k=p.blocksInAColumn;k>0;k--)g.push(k);else for(var l=e(),k=0;k<p.blocksInARow;k++){for(var m="",n=l;n>0;n--)m+=x.charAt(Math.floor(k%Math.pow(x.length,n)/Math.pow(x.length,n-1)));g.push(m)}for(var o="H"==d?p.blocksInARow:p.blocksInAColumn,k=0;k<o;k++){var m=new a.Text(g[k],j+"px sans",p.labelsColor);m.regX=m.getBounds().width/2,m.regY=m.getMeasuredLineHeight()/2;var q=p.borderSize/2+p.shadowSize+("H"==d?p.boardPaddingHeightSize:p.boardPaddingWidthSize),r=p.borderSize+k*(p.blockSize+p.marginBetweenBlocksSize)+p.blockSize/2+p.shadowSize+("H"==d?p.boardPaddingWidthSize:p.boardPaddingHeightSize);m.x="H"==d?r:q,m.y="H"==d?q:r;var s=p.borderSize/2+("H"==d?p.allBlocksHeight:p.allBlocksWidth)+p.borderSize+p.shadowSize+("H"==d?p.boardPaddingHeightSize:p.boardPaddingWidthSize),t=m.clone();"H"==d?t.y=s:t.x=s,b.addChild(m),b.addChild(t)}}function h(a,b){var c;return c="linesGrid"==p.type?p.lightSquaresColor:b%2?a%2?p.darkSquaresColor:p.lightSquaresColor:a%2?p.lightSquaresColor:p.darkSquaresColor}function j(a,b,c){function d(){e.moveTo(p.blockSize/2,p.blockSize/2).beginFill(p.linesColor).drawCircle(p.blockSize/2,p.blockSize/2,2.5*p.gridLinesSize)}var e=a.graphics;e.beginStroke(p.linesColor).setStrokeStyle(p.gridLinesSize),0!==b&&e.moveTo(p.blockSize/2,p.blockSize/2).lineTo(0,p.blockSize/2),b!=p.blocksInARow-1&&e.moveTo(p.blockSize/2,p.blockSize/2).lineTo(p.blockSize,p.blockSize/2),0!==c&&e.moveTo(p.blockSize/2,p.blockSize/2).lineTo(p.blockSize/2,p.blockSize),c!=p.blocksInAColumn-1&&e.moveTo(p.blockSize/2,p.blockSize/2).lineTo(p.blockSize/2,0),p.goGame&&(p.blocksInARow%2!==0&&b==Math.floor(p.blocksInARow/2)&&c==Math.floor(p.blocksInARow/2)&&d(),p.blocksInARow>=9&&p.blocksInARow<13&&(2!=b&&p.blocksInARow-b!=3||2!=c&&p.blocksInARow-c!=3||d()),p.blocksInARow>=13&&(3!=b&&p.blocksInARow-b!=4||3!=c&&p.blocksInARow-c!=4||d()),p.blocksInARow>=19&&((3!=b&&p.blocksInARow-b!=4||c!=Math.floor(p.blocksInARow/2))&&(3!=c&&p.blocksInARow-c!=4||b!=Math.floor(p.blocksInARow/2))||d()))}if(!d||!d.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(o=document.getElementById(d.canvasId),p=c(d),o.width=p.canvasWidth,o.height=p.canvasHeight,n=new a.Stage(o),n.scaleX=n.scaleY=n.scale=1,n.regX=p.canvasWidth/2,n.regY=p.canvasHeight/2,n.x=p.canvasWidth/2,n.y=p.canvasHeight/2,n.enableMouseOver(40),n.mouseMoveOutside=!0,n.rotation=0,p.borderSize>0){var k=new a.Container,l=new a.Shape;if(l.graphics.beginStroke(p.borderColor).setStrokeStyle(p.borderSize).drawRect(p.borderSize/2+p.shadowSize+p.boardPaddingWidthSize,p.borderSize/2+p.shadowSize+p.boardPaddingHeightSize,p.allBlocksWidth+p.borderSize,p.allBlocksHeight+p.borderSize),l.shadow=new a.Shadow(p.shadowColor,0,0,15),k.addChild(l),p.coords){var m=new a.Container,v=Math.min(Math.floor(.6*p.borderSize),p.blockSize);g(m,v,"V"),g(m,v,"H"),u.push(m),k.addChild(m)}n.addChild(k)}var w=new a.Container;if(w.regX=p.allBlocksWidth/2,w.regY=p.allBlocksHeight/2,w.x=p.canvasWidth/2,w.y=p.canvasHeight/2,w.scaleX=w.scaleY=w.scale=1,w.name="boardContainer",p.marginBetweenBlocksSize>0){var y=new a.Shape,z=y.graphics;z.beginStroke(p.marginColor).setStrokeStyle(p.marginBetweenBlocksSize);for(var A=0;A<p.blocksInARow-1;A++)z.moveTo(p.blockSize+p.marginBetweenBlocksSize/2+(p.blockSize+p.marginBetweenBlocksSize)*A,0).lineTo(p.blockSize+p.marginBetweenBlocksSize/2+(p.blockSize+p.marginBetweenBlocksSize)*A,p.allBlocksHeight);for(var A=0;A<p.blocksInAColumn-1;A++)z.moveTo(0,p.blockSize+p.marginBetweenBlocksSize/2+(p.blockSize+p.marginBetweenBlocksSize)*A).lineTo(p.allBlocksWidth,p.blockSize+p.marginBetweenBlocksSize/2+(p.blockSize+p.marginBetweenBlocksSize)*A);w.addChild(y)}for(var B=new a.Container,A=0;A<p.blocksInARow*p.blocksInAColumn;A++){var C=A%p.blocksInARow,D=Math.floor(A/p.blocksInARow),E=new a.Shape;E.graphics.beginFill(h(C,D)).drawRect(0,0,p.blockSize,p.blockSize);var F=i(C,D);E.x=F.x,E.y=F.y,E.regY=E.regX=p.blockSize/2,"linesGrid"==p.type&&j(E,C,D),B.addChild(E)}w.addChild(B),q=new a.Container,u.push(q),w.addChild(q),n.addChild(w),a.Ticker.addEventListener("tick",function(){var c,d,e,f,g,h,j,k,l,m,o,q,v,w,x=!1,y=!1,z=!1,A=!0,B=!1,C=!1,D=.2*p.rotationDuration,E=.6*p.rotationDuration;return function(F){if(!a.Ticker.getPaused()){if(r&&(r=!1,n.update()),s){if(!x||z)if(A&&(c=p.squeezeScaleFactor),B&&(c=g/n.scaleX),(A||B)&&(f=0,g=n.scaleX,d=n.scaleX*c-n.scaleX,e=d/D,A=!1,B=!1),Math.abs(f)>=Math.abs(d))n.scaleX=n.scaleY=g*c,x||(x=!0,y=!0,C=!0),z&&(z=!1,x=!1,A=!0,s=0);else{var G=F.delta*e;f+=G,n.scaleX=n.scaleY+=G}if(y){if(C){l=0,m=n.rotation,j=s,h=((j+m)%360+360)%360,k=j/E,o=Math.floor((m+45)%360/90),q=Math.floor((h+45)%360/90);var H=0;j>0?(H=(4-(o-q))%4*-90,0==H&&j>=45&&(H=-360)):j<0&&(H=(4+(o-q))%4*90,0==H&&j<-45&&(H=360)),H+=parseInt(j/360,10)*-360,w=H/E,v=(H%360+360)%360;for(var I=0;I<u.length;I++)for(var J=u[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.elementPreviousRotation=L.rotation}C=!1}if(l>=Math.abs(j)){n.rotation=h;for(var I=0;I<u.length;I++)for(var J=u[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.rotation=(L.elementPreviousRotation+v)%360,delete L.elementPreviousRotation}z=!0,B=!0,o=0,q=0,y=!1}else{var G=F.delta*k%360;l+=Math.abs(G),n.rotation=n.rotation+=G;for(var I=0;I<u.length;I++)for(var J=u[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);G=F.delta*w,L.rotation+=G}}}r=!0}if(t.length>0){for(var I=t.length-1;I>=0;I--){var M=t[I],N=i(M.destFile,M.destRank),O=N.x-M.piece.x,P=N.y-M.piece.y;p.animationOfPieces&&(M.piece.file==b&&M.piece.rank==b||(M.piece.file=b,M.piece.rank=b),t[I].piece.x+=.2*O,t[I].piece.y+=.2*P),(!p.animationOfPieces||Math.abs(P)<=1&&Math.abs(O)<=1)&&(M.piece.x=N.x,M.piece.y=N.y,M.piece.file=M.destFile,M.piece.rank=M.destRank,t.splice(I,1))}r=!0}}}}()),a.Ticker.setFPS(40),r=!0,p.position&&this.setPosition(p.position)}.bind(this)()}});