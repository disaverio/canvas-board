"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){function c(c){this.utils={_getNumberOfChars:function(a,b){return Math.ceil(Math.log(a)/Math.log(b))}.bind(this),getNumberOfCharsInHorizontalBoardLabels:function(){return this.utils._getNumberOfChars(this.configuration.blocksInARow,d.length)||1}.bind(this),getNumberOfCharsInVerticalBoardLabels:function(){return this.utils._getNumberOfChars(this.configuration.blocksInAColumn,10)||1}.bind(this),getFileRankFromPositionLabel:function(a){for(var b=this.utils.getNumberOfCharsInHorizontalBoardLabels(),c=a.substr(0,b),e=a.substr(b),f=0,g=0;g<b;g++)f+=d.indexOf(c.charAt(g))*Math.pow(d.length,b-(g+1));var h=e-1;return{file:f,rank:h}}.bind(this),getPositionLabelFromFileRank:function(a,b){for(var c=this.utils.getNumberOfCharsInHorizontalBoardLabels(),e="",f=c;f>0;f--)e+=d.charAt(Math.floor(a%Math.pow(d.length,f)/Math.pow(d.length,f-1)));return e+=b+1}.bind(this),getXYCoordsFromFileRank:function(a,b){return{x:a*(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)+this.configuration.blockSize/2,y:(this.configuration.blocksInAColumn-b-1)*(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)+this.configuration.blockSize/2}}.bind(this),getFileRankFromXYCoords:function(a,b){return{file:Math.floor((a+this.configuration.marginBetweenBlocksSize/2)/(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)),rank:this.configuration.blocksInAColumn-Math.floor((b+this.configuration.marginBetweenBlocksSize/2)/(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize))-1}}.bind(this),isPositionLabel:function(a){if("string"!=typeof a)return!1;for(var b=this.utils.getNumberOfCharsInHorizontalBoardLabels(),c=a.substr(0,b),e=0,f=0;f<b;f++){var g=d.indexOf(c.charAt(f));if(g<0)return!1;e+=g*Math.pow(d.length,b-(f+1))}if(e>=this.configuration.blocksInARow)return!1;var h=a.substr(b);return!(!Number.isInteger(parseInt(h,10))||parseInt(h,10)<1||parseInt(h,10)>this.configuration.blocksInAColumn)}.bind(this),isArray:function(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}.bind(this),isPiece:function(a){return!("object"!=typeof a||!a.label||!this.piecesBox[a.label])}.bind(this),getCurrentBoard:function(){for(var a=[],c=0;c<this.configuration.blocksInARow;c++){for(var d=[],e=0;e<this.configuration.blocksInAColumn;e++)d.push(b);a.push(d)}for(var c=0;c<this.piecesContainer.getNumChildren();c++){var f=this.piecesContainer.getChildAt(c);f.rank!=b&&f.file!=b&&(a[f.file][f.rank]||(a[f.file][f.rank]=[]),a[f.file][f.rank].push(f.label))}return a}.bind(this),getFenFromBoard:function(a){if(!this.utils.isArray(a))throw new Error("getFenFromBoard: invalid input parameter");for(var c,d=a.length,e=0;e<d;e++){if(!this.utils.isArray(a[e]))throw new Error("getFenFromBoard: invalid input parameter");if(0==e)c=a[e].length;else if(c!=a[e].length)throw new Error("getFenFromBoard: invalid input parameter");for(var f=0;f<c;f++)if(a[e][f]!=b&&!this.utils.isArray(a[e][f]))throw new Error("getFenFromBoard: invalid input parameter")}if(!c)throw new Error("getFenFromBoard: invalid input parameter");for(var g="",e=c-1;e>=0;e--){e!=c-1&&(g+="/");for(var h=0,f=0;f<d;f++)if(a[f][e]&&a[f][e].length>0)if(h>0&&(g+=h,h=0),1==a[f][e].length)g+=a[f][e][0];else{g+="[";for(var i=0;i<a[f][e].length;i++)g+=a[f][e][i];g+="]"}else h++;h>0&&(g+=h)}return g}.bind(this),getBoardFromFen:function(a){function c(a){for(var b=0,c=0;c<a.length;)if(isNaN(a[c])){if("["!=a[c])c++;else{for(var d=!1,e=1;e+c<a.length;e++)if("]"==a[c+e]){d=!0;break}if(!d)throw new Error("getBoardFromFen: invalid input parameter");c+=e+1}b++}else{for(var e=1;e+c<a.length&&!isNaN(a[c+e]);e++);var f=e,g=a.substr(c,f);b+=parseInt(g,10),c+=f}return b}for(var d,e=a.split("/"),f=e.length,g=0;g<f;g++)if(0==g)d=c(e[g]);else if(d!=c(e[g]))throw new Error("getBoardFromFen: invalid input parameter");for(var h=[],g=0;g<d;g++){for(var i=[],j=0;j<f;j++)i.push(b);h.push(i)}for(var g=0;g<f;g++)for(var k=0,j=0;j<e[g].length;)if(isNaN(e[g][j])){var l=[];if("["==e[g][j]){for(j++;"]"!=e[g][j];)l.push(e[g][j]),j++;j++}else l.push(e[g][j]),j++;h[k][f-g-1]=l,k++}else{for(var m=1;m+j<e[g].length&&!isNaN(e[g][j+m]);m++);var n=m,o=e[g].substr(j,n);k+=parseInt(o,10),j+=n}return h}.bind(this),createPiece:function(a){var b=e.defer();if(this.piecesBox[a])b.resolve(this.piecesBox[a]);else{if(!this.loadingPieces[a]){var c=new Image;c.src=this.configuration.piecesFolder+"/"+(this.configuration.piecesFiles[a]||a)+".png",c.onload=function(b){var c=b.target;this.piecesBox[a]=c,this.loadingPieces[a].deferreds.forEach(function(a){a.resolve(c)}),delete this.loadingPieces[a]}.bind(this),c.onerror=function(b){this.loadingPieces[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete this.loadingPieces[a]},this.loadingPieces[a]={piece:c,deferreds:[]}}this.loadingPieces[a].deferreds.push(b)}return b.promise}.bind(this)},this.stage,this.canvas,this.configuration,this.selectedPiece,this.piecesContainer,this.loadingPieces={},this.piecesBox={},this.update=!1,this.rotationDegrees=0,this.listOfMovements=[],this.containersToRotate=[],function(){function e(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||this.canvas.width,e=a.canvasSize||a.canvasHeight||d||this.canvas.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(0!=a.blocksMargin&&a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),m=l/(100*h+3*(h-1)),n=e-2*(c+j),o=n/(100*i+3*(i-1)),p=Math.min(m,o);g=Math.floor(100*p);var q=d-g*h-2*(c+j),r=q/(h-1),s=e-g*i-2*(c+j),t=s/(i-1);k=Math.floor(Math.min(r,t))}else k=a.blocksMargin;var u=(d-2*(c+j)-k*(h-1))/h,v=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(u,v));var w=g*h+k*(h-1),x=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:w,allBlocksHeight:x,boardPaddingWidthSize:(d-w-2*(c+j))/2,boardPaddingHeightSize:(e-x-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type||a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",piecesFiles:a.piecesFiles||{},actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,position:a.position,hooks:a.hooks||{},chessGame:a.chessGame||{}}}function f(b,c,e){var f=[],g=this.utils.getNumberOfCharsInHorizontalBoardLabels(),h=this.utils.getNumberOfCharsInVerticalBoardLabels(),i=c/Math.max(g,h);if("V"==e)for(var j=this.configuration.blocksInAColumn;j>0;j--)f.push(j);else for(var k=this.utils.getNumberOfCharsInHorizontalBoardLabels(),j=0;j<this.configuration.blocksInARow;j++){for(var l="",m=k;m>0;m--)l+=d.charAt(Math.floor(j%Math.pow(d.length,m)/Math.pow(d.length,m-1)));f.push(l)}for(var n="H"==e?this.configuration.blocksInARow:this.configuration.blocksInAColumn,j=0;j<n;j++){var l=new a.Text(f[j],i+"px sans",this.configuration.labelsColor);l.regX=l.getBounds().width/2,l.regY=l.getMeasuredLineHeight()/2;var o=this.configuration.borderSize/2+this.configuration.shadowSize+("H"==e?this.configuration.boardPaddingHeightSize:this.configuration.boardPaddingWidthSize),p=this.configuration.borderSize+j*(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)+this.configuration.blockSize/2+this.configuration.shadowSize+("H"==e?this.configuration.boardPaddingWidthSize:this.configuration.boardPaddingHeightSize);l.x="H"==e?p:o,l.y="H"==e?o:p;var q=this.configuration.borderSize/2+("H"==e?this.configuration.allBlocksHeight:this.configuration.allBlocksWidth)+this.configuration.borderSize+this.configuration.shadowSize+("H"==e?this.configuration.boardPaddingHeightSize:this.configuration.boardPaddingWidthSize),r=l.clone();"H"==e?r.y=q:r.x=q,b.addChild(l),b.addChild(r)}}function g(a,b){var c;return c="linesGrid"==this.configuration.type?this.configuration.lightSquaresColor:b%2?a%2?this.configuration.darkSquaresColor:this.configuration.lightSquaresColor:a%2?this.configuration.lightSquaresColor:this.configuration.darkSquaresColor}function h(a,b,c){function d(){e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).beginFill(this.configuration.linesColor).drawCircle(this.configuration.blockSize/2,this.configuration.blockSize/2,2.5*this.configuration.gridLinesSize)}var e=a.graphics;e.beginStroke(this.configuration.linesColor).setStrokeStyle(this.configuration.gridLinesSize),0!==b&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(0,this.configuration.blockSize/2),b!=this.configuration.blocksInARow-1&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize,this.configuration.blockSize/2),0!==c&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize/2,this.configuration.blockSize),c!=this.configuration.blocksInAColumn-1&&e.moveTo(this.configuration.blockSize/2,this.configuration.blockSize/2).lineTo(this.configuration.blockSize/2,0),this.configuration.goGame&&(this.configuration.blocksInARow%2!==0&&b==Math.floor(this.configuration.blocksInARow/2)&&c==Math.floor(this.configuration.blocksInARow/2)&&d.call(this),this.configuration.blocksInARow>=9&&this.configuration.blocksInARow<13&&(2!=b&&this.configuration.blocksInARow-b!=3||2!=c&&this.configuration.blocksInARow-c!=3||d.call(this)),this.configuration.blocksInARow>=13&&(3!=b&&this.configuration.blocksInARow-b!=4||3!=c&&this.configuration.blocksInARow-c!=4||d.call(this)),this.configuration.blocksInARow>=19&&((3!=b&&this.configuration.blocksInARow-b!=4||c!=Math.floor(this.configuration.blocksInARow/2))&&(3!=c&&this.configuration.blocksInARow-c!=4||b!=Math.floor(this.configuration.blocksInARow/2))||d.call(this)))}if(!c||!c.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(this.canvas=document.getElementById(c.canvasId),this.configuration=e(c),this.canvas.width=this.configuration.canvasWidth,this.canvas.height=this.configuration.canvasHeight,this.stage=new a.Stage(this.canvas),this.stage.scaleX=this.stage.scaleY=this.stage.scale=1,this.stage.regX=this.configuration.canvasWidth/2,this.stage.regY=this.configuration.canvasHeight/2,this.stage.x=this.configuration.canvasWidth/2,this.stage.y=this.configuration.canvasHeight/2,this.stage.enableMouseOver(40),this.stage.mouseMoveOutside=!0,this.stage.rotation=0,this.configuration.borderSize>0){var i=new a.Container,j=new a.Shape;if(j.graphics.beginStroke(this.configuration.borderColor).setStrokeStyle(this.configuration.borderSize).drawRect(this.configuration.borderSize/2+this.configuration.shadowSize+this.configuration.boardPaddingWidthSize,this.configuration.borderSize/2+this.configuration.shadowSize+this.configuration.boardPaddingHeightSize,this.configuration.allBlocksWidth+this.configuration.borderSize,this.configuration.allBlocksHeight+this.configuration.borderSize),j.shadow=new a.Shadow(this.configuration.shadowColor,0,0,15),i.addChild(j),this.configuration.coords){var k=new a.Container,l=Math.min(Math.floor(.6*this.configuration.borderSize),this.configuration.blockSize);f.call(this,k,l,"V"),f.call(this,k,l,"H"),this.containersToRotate.push(k),i.addChild(k)}this.stage.addChild(i)}var m=new a.Container;if(m.regX=this.configuration.allBlocksWidth/2,m.regY=this.configuration.allBlocksHeight/2,m.x=this.configuration.canvasWidth/2,m.y=this.configuration.canvasHeight/2,m.scaleX=m.scaleY=m.scale=1,m.name="boardContainer",this.configuration.marginBetweenBlocksSize>0){var n=new a.Shape,o=n.graphics;o.beginStroke(this.configuration.marginColor).setStrokeStyle(this.configuration.marginBetweenBlocksSize);for(var p=0;p<this.configuration.blocksInARow-1;p++)o.moveTo(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*p,0).lineTo(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*p,this.configuration.allBlocksHeight);for(var p=0;p<this.configuration.blocksInAColumn-1;p++)o.moveTo(0,this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*p).lineTo(this.configuration.allBlocksWidth,this.configuration.blockSize+this.configuration.marginBetweenBlocksSize/2+(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*p);m.addChild(n)}for(var q=new a.Container,p=0;p<this.configuration.blocksInARow*this.configuration.blocksInAColumn;p++){var r=p%this.configuration.blocksInARow,s=Math.floor(p/this.configuration.blocksInARow),t=new a.Shape;t.graphics.beginFill(g.call(this,r,s)).drawRect(0,0,this.configuration.blockSize,this.configuration.blockSize);var u=this.utils.getXYCoordsFromFileRank(r,s);t.x=u.x,t.y=u.y,t.regY=t.regX=this.configuration.blockSize/2,this.configuration.actionsOnPieces&&(t.addEventListener("rollover",function(b){if(this.selectedPiece){m.removeChild(m.getChildByName("blockHighlighter"));var c=m.globalToLocal(b.stageX,b.stageY);c.x<0&&(c.x=0),c.y<0&&(c.y=0);var d=this.utils.getFileRankFromXYCoords(c.x,c.y),e=new a.Shape;e.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*d.file+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-d.rank-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),e.name="blockHighlighter",m.addChildAt(e,m.getNumChildren()-1),this.update=!0}}.bind(this)),t.addEventListener("rollout",function(a){this.selectedPiece&&(m.removeChild(m.getChildByName("blockHighlighter")),this.update=!0)}.bind(this)),t.addEventListener("pressup",function(a){if(this.selectedPiece){m.removeChild(m.getChildByName("blockHighlighter"));var c=m.globalToLocal(a.stageX,a.stageY),d=this.utils.getFileRankFromXYCoords(c.x,c.y),e=this.utils.getPositionLabelFromFileRank(d.file,d.rank),f=this.move(this.selectedPiece,e);f||(this.selectedPiece.x=this.selectedPiece.startPosition.x,this.selectedPiece.y=this.selectedPiece.startPosition.y),this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b,this.update=!0}}.bind(this))),"linesGrid"==this.configuration.type&&h.call(this,t,r,s),q.addChild(t)}m.addChild(q),this.piecesContainer=new a.Container,this.containersToRotate.push(this.piecesContainer),m.addChild(this.piecesContainer),this.stage.addChild(m),a.Ticker.addEventListener("tick",function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=!1,q=!1,r=!1,s=!0,t=!1,u=!1,v=.2*this.configuration.rotationDuration,w=.6*this.configuration.rotationDuration;return function(x){if(!a.Ticker.getPaused()){if(this.update&&(this.update=!1,this.stage.update()),this.rotationDegrees){if(!p||r)if(s&&(b=this.configuration.squeezeScaleFactor),t&&(b=f/this.stage.scaleX),(s||t)&&(e=0,f=this.stage.scaleX,c=this.stage.scaleX*b-this.stage.scaleX,d=c/v,s=!1,t=!1),Math.abs(e)>=Math.abs(c))this.stage.scaleX=this.stage.scaleY=f*b,p||(p=!0,q=!0,u=!0),r&&(r=!1,p=!1,s=!0,this.rotationDegrees=0);else{var y=x.delta*d;e+=y,this.stage.scaleX=this.stage.scaleY+=y}if(q){if(u){j=0,k=this.stage.rotation,h=this.rotationDegrees,g=((h+k)%360+360)%360,i=h/w,l=Math.floor((k+45)%360/90),m=Math.floor((g+45)%360/90);var z=0;h>0?(z=(4-(l-m))%4*-90,0==z&&h>=90&&(z=-360)):h<0&&(z=(4+(l-m))%4*90,0==z&&h<-90&&(z=360)),z+=parseInt(h/360,10)*-360,o=z/w,n=(z%360+360)%360;for(var A=0;A<this.containersToRotate.length;A++)for(var B=this.containersToRotate[A],C=0;C<B.getNumChildren();C++){var D=B.getChildAt(C);D.elementPreviousRotation=D.rotation}u=!1}if(j>=Math.abs(h)){this.stage.rotation=g;for(var A=0;A<this.containersToRotate.length;A++)for(var B=this.containersToRotate[A],C=0;C<B.getNumChildren();C++){var D=B.getChildAt(C);D.rotation=(D.elementPreviousRotation+n)%360,delete D.elementPreviousRotation}r=!0,t=!0,l=0,m=0,q=!1}else{var y=x.delta*i%360;j+=Math.abs(y),this.stage.rotation+=y;for(var A=0;A<this.containersToRotate.length;A++)for(var B=this.containersToRotate[A],C=0;C<B.getNumChildren();C++){var D=B.getChildAt(C);y=x.delta*o,D.rotation+=y}}}this.update=!0}if(this.listOfMovements.length>0){for(var A=this.listOfMovements.length-1;A>=0;A--){var E=this.listOfMovements[A],F=this.utils.getXYCoordsFromFileRank(E.destFile,E.destRank),G=F.x-E.piece.x,H=F.y-E.piece.y;this.configuration.animationOfPieces&&(this.listOfMovements[A].piece.x+=.2*G,this.listOfMovements[A].piece.y+=.2*H),(!this.configuration.animationOfPieces||Math.abs(H)<=1&&Math.abs(G)<=1)&&(E.piece.x=F.x,E.piece.y=F.y,this.listOfMovements.splice(A,1))}this.update=!0}}}.bind(this)}.bind(this)()),a.Ticker.setFPS(40),this.update=!0,this.configuration.position&&this.setPosition(this.configuration.position)}.bind(this)()}if(!a)throw new Error("Fatal error: createjs not imported.");var d="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=e.defer();b.type="THEN";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):1==this.status&&c(this.value),b.promise},catch:function(a){var b=e.defer();b.type="CATCH";var c=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=c,this.successorDeferred.push(b)):2==this.status&&c(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}};return c.prototype.rotate=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("rotate: passed value is not an integer.");this.rotationDegrees=a||180},c.prototype.setRotation=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("setRotation: passed value is not an integer.");a=a||0,this.stage.rotation=(a%360+360)%360;for(var c=Math.floor((this.stage.rotation+45)%360/90)*-90,d=0;d<this.containersToRotate.length;d++)for(var e=this.containersToRotate[d],f=0;f<e.getNumChildren();f++){var g=e.getChildAt(f);g.rotation=c%360}this.update=!0},c.prototype.scale=function(a){if(a===b||isNaN(a)||a<0)throw new Error("scale: invalid scale parameter.");this.canvas.width=this.configuration.canvasWidth*a,this.canvas.height=this.configuration.canvasHeight*a,this.stage.scaleX=this.stage.scaleY=this.stage.scale=a,this.stage.x=this.configuration.canvasWidth*a/2,this.stage.y=this.configuration.canvasHeight*a/2,this.update=!0},c.prototype.setPosition=function(a){if(a==b||""==a){a="";for(var c=0;c<this.configuration.blocksInAColumn;c++)a.length>0&&(a+="/"),a+=this.configuration.blocksInARow}var d=this.utils.getCurrentBoard(),e=this.utils.getBoardFromFen(a);if(e.length!=this.configuration.blocksInARow||e[0].length!=this.configuration.blocksInAColumn)throw new Error("setPosition: invalid input parameter.");for(var f=[],g=[],c=0;c<this.configuration.blocksInARow;c++)for(var h=0;h<this.configuration.blocksInAColumn;h++)if(d[c][h]&&e[c][h])for(var i=0;i<this.piecesContainer.getNumChildren();i++){var j=this.piecesContainer.getChildAt(i);if(j.file==c&&j.rank==h){var k=e[c][h].indexOf(j.label);if(k!=-1&&d[c][h].indexOf(j.label)!=-1){if(f.push(j),1==e[c][h].length){e[c][h]=b;break}e[c][h].splice(k,1)}}}for(var c=0;c<this.configuration.blocksInARow;c++)for(var h=0;h<this.configuration.blocksInAColumn;h++)if(e[c][h])for(var i=0;i<this.piecesContainer.getNumChildren();i++){var j=this.piecesContainer.getChildAt(i);if(f.indexOf(j)==-1){var k=e[c][h].indexOf(j.label);if(k!=-1){for(var l=Math.pow(j.file-c,2)+Math.pow(j.rank-h,2),m=i+1;m<this.piecesContainer.getNumChildren();m++){var n=this.piecesContainer.getChildAt(m);if(e[c][h].indexOf(n.label)!=-1&&f.indexOf(n)==-1){var o=0;this.configuration.chessGame.bishopLabel&&n.label.toUpperCase()==this.configuration.chessGame.bishopLabel.toUpperCase()?(n.rank+n.file)%2==(c+h)%2&&(j.rank+j.file)%2!=(c+h)%2?j=n:((n.rank+n.file)%2!=(c+h)%2&&(j.rank+j.file)%2!=(c+h)%2||(n.rank+n.file)%2==(c+h)%2&&(j.rank+j.file)%2==(c+h)%2)&&(o=Math.pow(n.file-c,2)+Math.pow(n.rank-h,2)):this.configuration.chessGame.rookLabel&&n.label.toUpperCase()==this.configuration.chessGame.rookLabel.toUpperCase()?n.file!=c&&n.rank!=h||j.file==c||j.rank==h?o=Math.pow(n.file-c,2)+Math.pow(n.rank-h,2):j=n:this.configuration.chessGame.pawnLabel&&n.label.toUpperCase()==this.configuration.chessGame.pawnLabel.toUpperCase()?n.file==c&&j.file!=c?j=n:(n.file==c&&j.file==c||n.file!=c&&j.file!=c)&&(o=Math.pow(n.file-c,2)+Math.pow(n.rank-h,2)):o=Math.pow(n.file-c,2)+Math.pow(n.rank-h,2),o&&o<l&&(l=o,j=n)}}if(f.push(j),g.push([j,this.utils.getPositionLabelFromFileRank(c,h)]),1==e[c][h].length){e[c][h]=b;break}e[c][h].splice(k,1)}}}for(var c=this.piecesContainer.getNumChildren()-1;c>=0;c--){var j=this.piecesContainer.getChildAt(c);f.indexOf(j)==-1&&this.removePiece(j)}var p,q;0==this.piecesContainer.getNumChildren()&&this.configuration.animationOfPieces&&(p=this.configuration.allBlocksWidth/2,q=this.configuration.allBlocksHeight/2);for(var c=0;c<this.configuration.blocksInARow;c++)for(var h=0;h<this.configuration.blocksInAColumn;h++)if(e[c][h])for(var i=0;i<e[c][h].length;i++){var r=this.getNewPiece(e[c][h][i]);r.then(function(a,b,c){c.x=p,c.y=q,this.setPieceAtPosition(c,this.utils.getPositionLabelFromFileRank(a,b))}.bind(this,c,h)).catch(function(a){console.log(a)})}this.setPieceAtPosition.apply(this,g)},c.prototype.getPosition=function(){return this.utils.getFenFromBoard(getCurrentBoard())},c.prototype.move=function(){if(2==arguments.length&&(this.utils.isPositionLabel(arguments[0])||this.utils.isPiece(arguments[0]))&&this.utils.isPositionLabel(arguments[1]))return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),c=[];a.forEach(function(a){if(a){var d,e;if(this.utils.isPiece(a[0]))e=this.utils.getPositionLabelFromFileRank(a[0].file,a[0].rank),d=[a[0]];else{if(!this.utils.isPositionLabel(a[0]))return;if(e=a[0],d=this.getPieceAtPosition(e),!d)return;this.utils.isArray(d)||(d=[d])}if(this.utils.isPositionLabel(a[1])){var f=this.getPieceAtPosition(a[1]);f?this.utils.isArray(f)||(f=[f]):f=[],d.forEach(function(d){if(this.configuration.hooks.isValidMove){var g=this.configuration.hooks.isValidMove.call(this,e,a[1],d,f);if(1==g)c.push([e,a[1],d,f]);else if(0!=g&&g!=b)throw new Error(".isValidMove: invalid hook function.")}else c.push([e,a[1],d,f])}.bind(this))}}}.bind(this));var d=!1;return c.forEach(function(a){var b;this.configuration.hooks.preMove&&(b=this.configuration.hooks.preMove.call(this,a[0],a[1],a[2],a[3])),this.piecesContainer.removeChild(a[2]),this.piecesContainer.addChild(a[2]);var c=this.setPieceAtPosition(a[2],a[1]);this.configuration.hooks.postMove&&this.configuration.hooks.postMove.call(this,a[0],a[1],a[2],a[3],b,c),d=c||d}.bind(this)),d},c.prototype.setPieceAtPosition=function(){if(2==arguments.length&&this.utils.isPiece(arguments[0])&&this.utils.isPositionLabel(arguments[1]))return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[],c=!1;return a.forEach(function(a){if(this.utils.isPiece(a[0])&&this.utils.isPositionLabel(a[1])){var d=a[0],e=a[1],f=this.utils.getFileRankFromPositionLabel(e),g=f.file,h=f.rank;if(!this.piecesContainer.contains(d)){if(!d.x||!d.y){var i=this.utils.getXYCoordsFromFileRank(g,h);d.x=i.x,d.y=i.y}this.piecesContainer.addChild(d)}for(var j=!1,k=0;k<this.listOfMovements.length;k++){var l=this.listOfMovements[k];if(l.piece==d){l.destFile=g,l.destRank=h,j=!0;break}}j||b.push({piece:d,destFile:g,destRank:h}),d.file=g,d.rank=h,c=!0}}.bind(this)),!!c&&(this.listOfMovements=this.listOfMovements.concat(b),!0)},c.prototype.getPieceAtPosition=function(a){if(!this.utils.isPositionLabel(a))throw new Error("getPieceAtPosition: invalid position.");for(var c=this.utils.getFileRankFromPositionLabel(a),d=c.file,e=c.rank,f=[],g=this.piecesContainer.getNumChildren()-1;g>=0;g--){var h=this.piecesContainer.getChildAt(g);h.file==d&&h.rank==e&&f.push(h)}return 0==f.length?b:1==f.length?f[0]:f},c.prototype.removePieceFromPosition=function(a){if(!this.utils.isPositionLabel(a))throw new Error("removePieceFromPosition: invalid position.");var b=this.getPieceAtPosition(a);return!!b&&(this.utils.isArray(b)||(b=[b]),b.forEach(function(a){this.piecesContainer.removeChild(a)}.bind(this)),this.update=!0,!0)},c.prototype.removePiece=function(a){if(!this.utils.isPiece(a))throw new Error("removePiece: invalid input parameter.");return!!this.piecesContainer.contains(a)&&(this.piecesContainer.removeChild(a),this.update=!0,!0)},c.prototype.getNewPiece=function(c){var d=e.defer(),f=this.utils.createPiece(c);return f.then(function(e){var e=new a.Bitmap(e);e.label=c,e.regX=e.regY=this.piecesBox[c].width/2,e.scaleX=e.scaleY=e.scale=.9*this.configuration.blockSize/this.piecesBox[c].width,e.x=b,e.y=b;var f=Math.floor((this.stage.rotation+45)%360/90);e.rotation=f*-90,this.configuration.actionsOnPieces&&(e.cursor="pointer",e.hitArea=new a.Shape,e.hitArea.graphics.beginFill("#000").drawRect(0,0,this.piecesBox[c].width,this.piecesBox[c].height),e.addEventListener("rollover",function(b){if(this.selectedPiece){this.stage.getChildByName("boardContainer").removeChild(this.stage.getChildByName("boardContainer").getChildByName("blockHighlighter"));var c=this.stage.getChildByName("boardContainer").globalToLocal(b.stageX,b.stageY),d=this.utils.getFileRankFromXYCoords(c.x,c.y),e=new a.Shape;e.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*d.file+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-d.rank-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),e.name="blockHighlighter",this.stage.getChildByName("boardContainer").addChildAt(e,this.stage.getChildByName("boardContainer").getNumChildren()-1),this.update=!0}else{var f=b.target;f.scaleX=f.scaleY=1.25*f.scale,f.shadow=new a.Shadow(this.configuration.shadowColor,3,3,5),this.update=!0}}.bind(this)),e.addEventListener("rollout",function(a){if(this.selectedPiece)this.stage.getChildByName("boardContainer").removeChild(this.stage.getChildByName("boardContainer").getChildByName("blockHighlighter")),this.update=!0;else{var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,this.update=!0}}.bind(this)),e.addEventListener("mousedown",function(a){for(var c=a.target,d=0;d<this.listOfMovements.length;d++)if(this.listOfMovements[d].piece==c){this.listOfMovements.splice(d,1);break}var e={};if(c.file!=b&&c.rank!=b&&(e=this.utils.getXYCoordsFromFileRank(c.file,c.rank)),c.startPosition={x:e.x||c.x,y:e.y||c.y},!this.selectedPiece){var f=this.stage.getChildByName("boardContainer"),g=f.globalToLocal(a.stageX,a.stageY);this.piecesContainer.removeChild(c),this.piecesContainer.addChild(c),c.x=g.x,c.y=g.y,this.update=!0}}.bind(this)),e.addEventListener("pressmove",function(c){var d=c.target,e=this.stage.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY);this.selectedPiece&&(e.removeChild(e.getChildByName("blockHighlighter")),this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b,d.scaleX=d.scaleY=1.25*d.scale,d.shadow=new a.Shadow(this.configuration.shadowColor,3,3,5),this.piecesContainer.removeChild(d),this.piecesContainer.addChild(d),d.x=f.x,d.y=f.y,this.update=!0);var g=this.utils.getFileRankFromXYCoords(f.x,f.y),h=g.file,i=g.rank;d.x=f.x,d.y=f.y;var j=b;if(h>=0&&h<this.configuration.blocksInARow&&i>=0&&i<this.configuration.blocksInAColumn&&(j=h+this.configuration.blocksInARow*i),j!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=j,j!=b)){if("linesGrid"==this.configuration.type){var k=new a.Shape;k.alpha=.8,k.graphics.beginFill(this.configuration.highlighterColor).drawCircle((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(d.currentSquare%this.configuration.blocksInARow)+this.configuration.blockSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-Math.floor(d.currentSquare/this.configuration.blocksInARow)-1)+this.configuration.blockSize/2,2.5*this.configuration.highlighterSize),k.name="blockHighlighter"}else{var k=new a.Shape;k.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*h+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-i-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),k.name="blockHighlighter"}e.addChildAt(k,e.getNumChildren()-1)}this.update=!0}.bind(this)),e.addEventListener("pressup",function(c){var d=c.target,e=this.stage.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),g=this.utils.getFileRankFromXYCoords(f.x,f.y),h=g.file,i=g.rank;e.removeChild(e.getChildByName("blockHighlighter"));var j=b;if(h>=0&&h<this.configuration.blocksInARow&&i>=0&&i<this.configuration.blocksInAColumn&&(j=h+this.configuration.blocksInARow*i),j==b)d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0;else if(j!=d.file+this.configuration.blocksInARow*d.rank){var k=this.utils.getPositionLabelFromFileRank(h,i),l=this.move(d,k);l||(d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0)}else{if(this.selectedPiece){if(d!=this.selectedPiece){var k=this.utils.getPositionLabelFromFileRank(h,i),l=this.move(this.selectedPiece,k);l||(this.selectedPiece.x=this.selectedPiece.startPosition.x,this.selectedPiece.y=this.selectedPiece.startPosition.y)}this.selectedPiece.scaleX=this.selectedPiece.scaleY=this.selectedPiece.scale,this.selectedPiece.shadow=null,this.selectedPiece=b}else{this.selectedPiece=d;var m=new a.Shape;m.graphics.beginStroke(this.configuration.highlighterColor).setStrokeStyle(this.configuration.highlighterSize).drawRect((this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*h+this.configuration.highlighterSize/2,(this.configuration.blockSize+this.configuration.marginBetweenBlocksSize)*(this.configuration.blocksInAColumn-i-1)+this.configuration.highlighterSize/2,this.configuration.blockSize-this.configuration.highlighterSize,this.configuration.blockSize-this.configuration.highlighterSize),
m.name="blockHighlighter",e.addChildAt(m,e.getNumChildren()-1)}d.x=d.startPosition.x,d.y=d.startPosition.y,this.update=!0}}.bind(this))),d.resolve(e)}.bind(this)).catch(function(a){d.reject(a)}),d.promise},c});