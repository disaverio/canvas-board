"use strict";!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("createjs")):"function"==typeof define&&define.amd?define(["createjs"],b):a.CanvasBoard=b(a.createjs)}(this,function(a,b){var c={defer:function(){return{promise:{id:"lQ",status:0,value:b,successorDeferred:[],then:function(a){var b=c.defer();b.type="THEN";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):1==this.status&&d(this.value),b.promise},catch:function(a){var b=c.defer();b.type="CATCH";var d=function(c){try{var d=a(c);d&&"lQ"===d.id?d.then(function(a){b.resolve(a)}).catch(function(a){b.reject(a)}):b.resolve(d)}catch(a){b.reject(a)}};return 0==this.status?(b.f=d,this.successorDeferred.push(b)):2==this.status&&d(this.value),b.promise},finally:function(a){this.successorDeferred.push(a)}},resolve:function(a){for(this.promise.status=1,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},reject:function(a){for(this.promise.status=2,this.promise.value=a;this.promise.successorDeferred.length>0;){var b=this.promise.successorDeferred.splice(0,1)[0];b.exec?b.exec(this.promise.status,a):b(a)}},exec:function(a,b){if(1==a&&"THEN"==this.type||2==a&&"CATCH"==this.type)this.f(b);else for(;this.promise.successorDeferred.length>0;)this.promise.successorDeferred.splice(0,1)[0].exec(a,b)}}}};return function(d){function e(a,b){return Math.ceil(Math.log(a)/Math.log(b))}function f(){return e(u.blocksInARow,D.length)||1}function g(){return e(u.blocksInAColumn,10)||1}function h(a){for(var b=f(),c=a.substr(0,b),d=a.substr(b),e=0,g=0;g<b;g++)e+=D.indexOf(c.charAt(g))*Math.pow(D.length,b-(g+1));var h=d-1;return{file:e,rank:h}}function i(a,b){for(var c=f(),d="",e=c;e>0;e--)d+=D.charAt(Math.floor(a%Math.pow(D.length,e)/Math.pow(D.length,e-1)));return d+=b+1}function j(a,b){return{x:a*(u.blockSize+u.marginBetweenBlocksSize)+u.blockSize/2,y:(u.blocksInAColumn-b-1)*(u.blockSize+u.marginBetweenBlocksSize)+u.blockSize/2}}function k(a,b){return{file:Math.floor((a+u.marginBetweenBlocksSize/2)/(u.blockSize+u.marginBetweenBlocksSize)),rank:u.blocksInAColumn-Math.floor((b+u.marginBetweenBlocksSize/2)/(u.blockSize+u.marginBetweenBlocksSize))-1}}function l(a){if("string"!=typeof arguments[0])return!1;for(var b=f(),c=a.substr(0,b),d=0,e=0;e<b;e++){var g=D.indexOf(c.charAt(e));if(g<0)return!1;d+=g*Math.pow(D.length,b-(e+1))}if(d>=u.blocksInARow)return!1;var h=a.substr(b);return!(!Number.isInteger(parseInt(h,10))||parseInt(h,10)<1||parseInt(h,10)>u.blocksInAColumn)}function m(a){return Array.isArray?Array.isArray(a):"undefined"!=typeof a&&a&&a.constructor===Array}function n(a){return!("object"!=typeof a||!a.label||!B[a.label])}function o(){for(var a=[],c=0;c<u.blocksInARow;c++){for(var d=[],e=0;e<u.blocksInAColumn;e++)d.push(b);a.push(d)}for(var c=0;c<v.getNumChildren();c++){var f=v.getChildAt(c);f.rank!=b&&f.file!=b&&(a[f.file][f.rank]||(a[f.file][f.rank]=[]),a[f.file][f.rank].push(f.label))}return a}function p(a){if(!m(a))throw new Error("_getFenFromBoard: invalid input parameter");for(var c,d=a.length,e=0;e<d;e++){if(!m(a[e]))throw new Error("_getFenFromBoard: invalid input parameter");if(0==e)c=a[e].length;else if(c!=a[e].length)throw new Error("_getFenFromBoard: invalid input parameter");for(var f=0;f<c;f++)if(a[e][f]!=b&&!m(a[e][f]))throw new Error("_getFenFromBoard: invalid input parameter")}if(!c)throw new Error("_getFenFromBoard: invalid input parameter");for(var g="",e=c-1;e>=0;e--){e!=c-1&&(g+="/");for(var h=0,f=0;f<d;f++)if(a[f][e]&&a[f][e].length>0)if(h>0&&(g+=h,h=0),1==a[f][e].length)g+=a[f][e][0];else{g+="[";for(var i=0;i<a[f][e].length;i++)g+=a[f][e][i];g+="]"}else h++;h>0&&(g+=h)}return g}function q(a){function c(a){for(var b=0,c=0;c<a.length;)if(isNaN(a[c])){if("["!=a[c])c++;else{for(var d=!1,e=1;e+c<a.length;e++)if("]"==a[c+e]){d=!0;break}if(!d)throw new Error("_getBoardFromFen: invalid input parameter");c+=e+1}b++}else{for(var e=1;e+c<a.length&&!isNaN(a[c+e]);e++);var f=e,g=a.substr(c,f);b+=parseInt(g,10),c+=f}return b}for(var d,e=a.split("/"),f=e.length,g=0;g<f;g++)if(0==g)d=c(e[g]);else if(d!=c(e[g]))throw new Error("_getBoardFromFen: invalid input parameter");for(var h=[],g=0;g<d;g++){for(var i=[],j=0;j<f;j++)i.push(b);h.push(i)}for(var g=0;g<f;g++)for(var k=0,j=0;j<e[g].length;)if(isNaN(e[g][j])){var l=[];if("["==e[g][j]){for(j++;"]"!=e[g][j];)l.push(e[g][j]),j++;j++}else l.push(e[g][j]),j++;h[k][f-g-1]=l,k++}else{for(var m=1;m+j<e[g].length&&!isNaN(e[g][j+m]);m++);var n=m,o=e[g].substr(j,n);k+=parseInt(o,10),j+=n}return h}function r(a){var b=c.defer();if(B[a])b.resolve(B[a]);else{if(!C[a]){var d=new Image;d.src=u.piecesFolder+"/"+(u.piecesFiles[a]||a)+".png",d.onload=function(b){var c=b.target;B[a]=c,C[a].deferreds.forEach(function(a){a.resolve(c)}),delete C[a]},d.onerror=function(b){C[a].deferreds.forEach(function(b){b.reject("Error loading piece "+a)}),delete C[a]},C[a]={piece:d,deferreds:[]}}C[a].deferreds.push(b)}return b.promise}var s,t,u,v,w,x=!1,y=0,z=[],A=[],B={},C={},D="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.rotate=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("rotate: passed value is not an integer.");y=a||180},this.setRotation=function(a){if(a!==b&&!Number.isInteger(a))throw new Error("setRotation: passed value is not an integer.");a=a||0,s.rotation=(a%360+360)%360;for(var c=Math.floor((s.rotation+45)%360/90)*-90,d=0;d<A.length;d++)for(var e=A[d],f=0;f<e.getNumChildren();f++){var g=e.getChildAt(f);g.rotation=c%360}x=!0},this.scale=function(a){if(a===b||isNaN(a)||a<0)throw new Error("scale: invalid scale parameter.");t.width=u.canvasWidth*a,t.height=u.canvasHeight*a,s.scaleX=s.scaleY=s.scale=a,s.x=u.canvasWidth*a/2,s.y=u.canvasHeight*a/2,x=!0},this.setPosition=function(a){if(!a){a="";for(var c=0;c<u.blocksInAColumn;c++)a.length>0&&(a+="/"),a+=u.blocksInARow}var d=o(),e=q(a);if(e.length!=u.blocksInARow||e[0].length!=u.blocksInAColumn)throw new Error("setPosition: invalid input parameter.");for(var f=[],g=[],c=0;c<u.blocksInARow;c++)for(var h=0;h<u.blocksInAColumn;h++)if(d[c][h]&&e[c][h])for(var j=0;j<v.getNumChildren();j++){var k=v.getChildAt(j);if(k.file==c&&k.rank==h){var l=e[c][h].indexOf(k.label);if(l!=-1&&d[c][h].indexOf(k.label)!=-1){if(f.push(k),1==e[c][h].length){e[c][h]=b;break}e[c][h].splice(l,1)}}}if(z.length>0)for(var c=0;c<u.blocksInARow;c++)for(var h=0;h<u.blocksInAColumn;h++)if(e[c][h])for(var j=0;j<z.length;j++){var m=z[j];if(m.destFile==c&&m.destRank==h){var l=e[c][h].indexOf(m.piece.label);if(l!=-1){if(f.push(m.piece),g.push(m),1==e[c][h].length){e[c][h]=b;break}e[c][h].splice(l,1)}}}for(var c=0;c<u.blocksInARow;c++)for(var h=0;h<u.blocksInAColumn;h++)if(e[c][h])for(var j=0;j<v.getNumChildren();j++){var k=v.getChildAt(j);if(f.indexOf(k)==-1){var l=e[c][h].indexOf(k.label);if(l!=-1){for(var n=Math.pow(k.file-c,2)+Math.pow(k.rank-h,2),p=j+1;p<v.getNumChildren();p++){var r=v.getChildAt(p);if(e[c][h].indexOf(r.label)!=-1&&f.indexOf(r)==-1){var s=0;u.chessGame.bishopLabel&&r.label.toUpperCase()==u.chessGame.bishopLabel.toUpperCase()?(r.rank+r.file)%2==(c+h)%2&&(k.rank+k.file)%2!=(c+h)%2?k=r:((r.rank+r.file)%2!=(c+h)%2&&(k.rank+k.file)%2!=(c+h)%2||(r.rank+r.file)%2==(c+h)%2&&(k.rank+k.file)%2==(c+h)%2)&&(s=Math.pow(r.file-c,2)+Math.pow(r.rank-h,2)):u.chessGame.rookLabel&&r.label.toUpperCase()==u.chessGame.rookLabel.toUpperCase()?r.file!=c&&r.rank!=h||k.file==c||k.rank==h?s=Math.pow(r.file-c,2)+Math.pow(r.rank-h,2):k=r:u.chessGame.pawnLabel&&r.label.toUpperCase()==u.chessGame.pawnLabel.toUpperCase()?r.file==c&&k.file!=c?k=r:(r.file==c&&k.file==c||r.file!=c&&k.file!=c)&&(s=Math.pow(r.file-c,2)+Math.pow(r.rank-h,2)):s=Math.pow(r.file-c,2)+Math.pow(r.rank-h,2),s&&s<n&&(n=s,k=r)}}if(f.push(k),g.push({piece:k,destFile:c,destRank:h}),1==e[c][h].length){e[c][h]=b;break}e[c][h].splice(l,1)}}}for(var c=v.getNumChildren()-1;c>=0;c--){var k=v.getChildAt(c);f.indexOf(k)==-1&&this.removePiece(k)}var t,w;0==v.getNumChildren()&&u.animationOfPieces&&(t=u.allBlocksWidth/2,w=u.allBlocksHeight/2);for(var c=0;c<u.blocksInARow;c++)for(var h=0;h<u.blocksInAColumn;h++)if(e[c][h])for(var j=0;j<e[c][h].length;j++){var x=this.getNewPiece(e[c][h][j]);x.then(function(a,b){return function(c){c.x=t,c.y=w,this.setPieceAtPosition(c,i(a,b))}.bind(this)}.call(this,c,h)).catch(function(a){console.log(a)})}z=z.concat(g)},this.getPosition=function(){return p(o())},this.move=function(){if(2==arguments.length&&(l(arguments[0])||n(arguments[0]))&&l(arguments[1]))return this.move([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[];a.forEach(function(a){var c,d;if(n(a[0]))d=i(a[0].file,a[0].rank),c=[a[0]];else{if(!l(a[0]))return;if(d=a[0],c=this.getPieceAtPosition(d),!c)return;m(c)||(c=[c])}if(l(a[1])){var e=this.getPieceAtPosition(a[1]);e?m(e)||(e=[e]):e=[],c.forEach(function(c){u.hooks.isValidMove?u.hooks.isValidMove(d,a[1],c,e)&&b.push([d,a[1],c,e]):b.push([d,a[1],c,e])})}}.bind(this));var c=!1;return b.forEach(function(a){var b;u.hooks.preMove&&(b=u.hooks.preMove(a[0],a[1],a[2],a[3])),v.removeChild(a[2]),v.addChild(a[2]);var d=this.setPieceAtPosition(a[2],a[1]);u.hooks.postMove&&u.hooks.postMove(b,d,a[0],a[1],a[2],a[3]),c=d||c}.bind(this)),c},this.setPieceAtPosition=function(){if(2==arguments.length&&n(arguments[0])&&l(arguments[1]))return this.setPieceAtPosition([arguments[0],arguments[1]]);var a=Array.prototype.slice.call(arguments),b=[],c=!1;return a.forEach(function(a){if(n(a[0])&&l(a[1])){var d=a[0],e=a[1],f=h(e),g=f.file,i=f.rank;if(!v.contains(d)){if(!d.x||!d.y){var k=j(g,i);d.x=k.x,d.y=k.y}v.addChild(d)}for(var m=!1,o=0;o<z.length;o++){var p=z[o];if(p.piece==d){p.destFile=g,p.destRank=i,m=!0;break}}m||b.push({piece:d,destFile:g,destRank:i}),c=!0}}.bind(this)),!!c&&(z=z.concat(b),!0)},this.getPieceAtPosition=function(a){if(!l(a))throw new Error("getPieceAtPosition: invalid position.");for(var c=h(a),d=c.file,e=c.rank,f=[],g=v.getNumChildren()-1;g>=0;g--){var i=v.getChildAt(g);i.file==d&&i.rank==e&&f.push(i)}return 0==f.length?b:1==f.length?f[0]:f},this.removePieceFromPosition=function(a){if(!l(a))throw new Error("removePieceFromPosition: invalid position.");var b=this.getPieceAtPosition(a);return!!b&&(m(b)||(b=[b]),b.forEach(function(a){v.removeChild(a)}.bind(this)),x=!0,!0)},this.removePiece=function(a){return!!v.contains(a)&&(v.removeChild(a),x=!0,!0)},this.getNewPiece=function(d){var e=c.defer(),f=r(d);return f.then(function(c){var c=new a.Bitmap(c);c.label=d,c.regX=c.regY=B[d].width/2,c.scaleX=c.scaleY=c.scale=.9*u.blockSize/B[d].width,c.x=b,c.y=b;var f=Math.floor((s.rotation+45)%360/90);c.rotation=f*-90,u.actionsOnPieces&&(c.cursor="pointer",c.hitArea=new a.Shape,c.hitArea.graphics.beginFill("#000").drawRect(0,0,B[d].width,B[d].height),c.addEventListener("rollover",function(b){if(w){s.getChildByName("boardContainer").removeChild(s.getChildByName("boardContainer").getChildByName("blockHighlighter"));var c=s.getChildByName("boardContainer").globalToLocal(b.stageX,b.stageY),d=k(c.x,c.y),e=new a.Shape;e.graphics.beginStroke(u.highlighterColor).setStrokeStyle(u.highlighterSize).drawRect((u.blockSize+u.marginBetweenBlocksSize)*d.file+u.highlighterSize/2,(u.blockSize+u.marginBetweenBlocksSize)*(u.blocksInAColumn-d.rank-1)+u.highlighterSize/2,u.blockSize-u.highlighterSize,u.blockSize-u.highlighterSize),e.name="blockHighlighter",s.getChildByName("boardContainer").addChildAt(e,s.getChildByName("boardContainer").getNumChildren()-1),x=!0}else{var f=b.target;f.scaleX=f.scaleY=1.25*f.scale,f.shadow=new a.Shadow(u.shadowColor,3,3,5),x=!0}}.bind(this)),c.addEventListener("rollout",function(a){if(w)s.getChildByName("boardContainer").removeChild(s.getChildByName("boardContainer").getChildByName("blockHighlighter")),x=!0;else{var b=a.target;b.scaleX=b.scaleY=b.scale,b.shadow=null,x=!0}}.bind(this)),c.addEventListener("mousedown",function(a){var b=a.target;if(b.startPosition={x:b.x,y:b.y},!w){var c=s.getChildByName("boardContainer"),d=c.globalToLocal(a.stageX,a.stageY);v.removeChild(b),v.addChild(b),b.x=d.x,b.y=d.y,x=!0}}.bind(this)),c.addEventListener("pressmove",function(c){var d=c.target,e=s.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY);w&&(e.removeChild(e.getChildByName("blockHighlighter")),w.scaleX=w.scaleY=w.scale,w.shadow=null,w=b,d.scaleX=d.scaleY=1.25*d.scale,d.shadow=new a.Shadow(u.shadowColor,3,3,5),v.removeChild(d),v.addChild(d),d.x=f.x,d.y=f.y,x=!0);var g=k(f.x,f.y),h=g.file,i=g.rank;d.x=f.x,d.y=f.y;var j=b;if(h>=0&&h<u.blocksInARow&&i>=0&&i<u.blocksInAColumn&&(j=h+u.blocksInARow*i),j!=d.currentSquare&&(e.removeChild(e.getChildByName("blockHighlighter")),d.currentSquare=j,j!=b)){if("linesGrid"==u.type){var l=new a.Shape;l.alpha=.8,l.graphics.beginFill(u.highlighterColor).drawCircle((u.blockSize+u.marginBetweenBlocksSize)*(d.currentSquare%u.blocksInARow)+u.blockSize/2,(u.blockSize+u.marginBetweenBlocksSize)*(u.blocksInAColumn-Math.floor(d.currentSquare/u.blocksInARow)-1)+u.blockSize/2,2.5*u.highlighterSize),l.name="blockHighlighter"}else{var l=new a.Shape;l.graphics.beginStroke(u.highlighterColor).setStrokeStyle(u.highlighterSize).drawRect((u.blockSize+u.marginBetweenBlocksSize)*h+u.highlighterSize/2,(u.blockSize+u.marginBetweenBlocksSize)*(u.blocksInAColumn-i-1)+u.highlighterSize/2,u.blockSize-u.highlighterSize,u.blockSize-u.highlighterSize),l.name="blockHighlighter"}e.addChildAt(l,e.getNumChildren()-1)}x=!0}.bind(this)),c.addEventListener("pressup",function(c){var d=c.target,e=s.getChildByName("boardContainer"),f=e.globalToLocal(c.stageX,c.stageY),g=k(f.x,f.y),h=g.file,j=g.rank;e.removeChild(e.getChildByName("blockHighlighter"));var l=b;if(h>=0&&h<u.blocksInARow&&j>=0&&j<u.blocksInAColumn&&(l=h+u.blocksInARow*j),l==b)d.x=d.startPosition.x,d.y=d.startPosition.y,x=!0;else if(l!=d.file+u.blocksInARow*d.rank){var m=i(h,j),n=this.move(d,m);n||(d.x=d.startPosition.x,d.y=d.startPosition.y,x=!0)}else{if(w){var m=i(h,j),n=this.move(w,m);n||(w.x=w.startPosition.x,w.y=w.startPosition.y,x=!0),w.scaleX=w.scaleY=w.scale,w.shadow=null,w=b}else{w=d;var o=new a.Shape;o.graphics.beginStroke(u.highlighterColor).setStrokeStyle(u.highlighterSize).drawRect((u.blockSize+u.marginBetweenBlocksSize)*h+u.highlighterSize/2,(u.blockSize+u.marginBetweenBlocksSize)*(u.blocksInAColumn-j-1)+u.highlighterSize/2,u.blockSize-u.highlighterSize,u.blockSize-u.highlighterSize),o.name="blockHighlighter",e.addChildAt(o,e.getNumChildren()-1)}d.x=d.startPosition.x,d.y=d.startPosition.y,x=!0}}.bind(this))),e.resolve(c)}.bind(this)).catch(function(a){e.reject(a)}),e.promise},function(){function c(a){var c,d=a.canvasSize||a.canvasWidth||a.canvasHeight||t.width,e=a.canvasSize||a.canvasHeight||d||t.height;if(a.borderSize===b){var f=Math.min(d,e);c=.035*f}else c=a.borderSize;var g,h=a.blocksInARow||a.blocksInAColumn||8,i=a.goGame?h:a.blocksInAColumn||h||8,j=c,k=0;if(0!=a.blocksMargin&&a.blocksMargin!=b)if("auto"==a.blocksMargin){var l=d-2*(c+j),m=l/(100*h+3*(h-1)),n=e-2*(c+j),o=n/(100*i+3*(i-1)),p=Math.min(m,o);g=Math.floor(100*p);var q=d-g*h-2*(c+j),r=q/(h-1),s=e-g*i-2*(c+j),u=s/(i-1);k=Math.floor(Math.min(r,u))}else k=a.blocksMargin;var v=(d-2*(c+j)-k*(h-1))/h,w=(e-2*(c+j)-k*(i-1))/i;g=Math.floor(Math.min(v,w));var x=g*h+k*(h-1),y=g*i+k*(i-1);return{canvasId:a.canvasId,canvasWidth:d,canvasHeight:e,canvasSize:a.canvasSize,shadowSize:j,borderSize:c,blockSize:g,marginBetweenBlocksSize:k,highlighterSize:.03*g,allBlocksWidth:x,allBlocksHeight:y,boardPaddingWidthSize:(d-x-2*(c+j))/2,boardPaddingHeightSize:(e-y-2*(c+j))/2,gridLinesSize:a.gridLinesSize||.03*g,blocksInARow:h,blocksInAColumn:i,coords:a.coords!==!1,type:"linesGrid"===a.type||a.goGame===!0?"linesGrid":"blocksGrid",lightSquaresColor:a.lightSquaresColor||"#EFEFEF",darkSquaresColor:a.darkSquaresColor||"#ABABAB",linesColor:a.linesColor||"#000",borderColor:a.borderColor||"#222",shadowColor:a.shadowColor||"#000",labelsColor:a.labelsColor||"#DDD",highlighterColor:a.highlighterColor||"lightgreen",marginColor:a.marginColor||"#222",rotationDuration:a.rotationDuration===b?500:a.rotationDuration,squeezeScaleFactor:a.squeezeScaleFactor||.7,animationOfPieces:a.animationOfPieces!==!1,piecesFolder:a.piecesFolder||"./img",piecesFiles:a.piecesFiles||{},actionsOnPieces:a.actionsOnPieces!==!1,blocksMargin:a.blocksMargin||0,goGame:a.goGame===!0,position:a.position,hooks:a.hooks||{},chessGame:a.chessGame||{}}}function e(b,c,d){var e=[],h=f(),i=g(),j=c/Math.max(h,i);if("V"==d)for(var k=u.blocksInAColumn;k>0;k--)e.push(k);else for(var l=f(),k=0;k<u.blocksInARow;k++){for(var m="",n=l;n>0;n--)m+=D.charAt(Math.floor(k%Math.pow(D.length,n)/Math.pow(D.length,n-1)));e.push(m)}for(var o="H"==d?u.blocksInARow:u.blocksInAColumn,k=0;k<o;k++){var m=new a.Text(e[k],j+"px sans",u.labelsColor);m.regX=m.getBounds().width/2,m.regY=m.getMeasuredLineHeight()/2;var p=u.borderSize/2+u.shadowSize+("H"==d?u.boardPaddingHeightSize:u.boardPaddingWidthSize),q=u.borderSize+k*(u.blockSize+u.marginBetweenBlocksSize)+u.blockSize/2+u.shadowSize+("H"==d?u.boardPaddingWidthSize:u.boardPaddingHeightSize);m.x="H"==d?q:p,m.y="H"==d?p:q;var r=u.borderSize/2+("H"==d?u.allBlocksHeight:u.allBlocksWidth)+u.borderSize+u.shadowSize+("H"==d?u.boardPaddingHeightSize:u.boardPaddingWidthSize),s=m.clone();"H"==d?s.y=r:s.x=r,b.addChild(m),b.addChild(s)}}function h(a,b){var c;return c="linesGrid"==u.type?u.lightSquaresColor:b%2?a%2?u.darkSquaresColor:u.lightSquaresColor:a%2?u.lightSquaresColor:u.darkSquaresColor}function l(a,b,c){function d(){e.moveTo(u.blockSize/2,u.blockSize/2).beginFill(u.linesColor).drawCircle(u.blockSize/2,u.blockSize/2,2.5*u.gridLinesSize)}var e=a.graphics;e.beginStroke(u.linesColor).setStrokeStyle(u.gridLinesSize),0!==b&&e.moveTo(u.blockSize/2,u.blockSize/2).lineTo(0,u.blockSize/2),b!=u.blocksInARow-1&&e.moveTo(u.blockSize/2,u.blockSize/2).lineTo(u.blockSize,u.blockSize/2),0!==c&&e.moveTo(u.blockSize/2,u.blockSize/2).lineTo(u.blockSize/2,u.blockSize),c!=u.blocksInAColumn-1&&e.moveTo(u.blockSize/2,u.blockSize/2).lineTo(u.blockSize/2,0),u.goGame&&(u.blocksInARow%2!==0&&b==Math.floor(u.blocksInARow/2)&&c==Math.floor(u.blocksInARow/2)&&d(),u.blocksInARow>=9&&u.blocksInARow<13&&(2!=b&&u.blocksInARow-b!=3||2!=c&&u.blocksInARow-c!=3||d()),u.blocksInARow>=13&&(3!=b&&u.blocksInARow-b!=4||3!=c&&u.blocksInARow-c!=4||d()),u.blocksInARow>=19&&((3!=b&&u.blocksInARow-b!=4||c!=Math.floor(u.blocksInARow/2))&&(3!=c&&u.blocksInARow-c!=4||b!=Math.floor(u.blocksInARow/2))||d()))}if(!d||!d.canvasId)throw new Error("CanvasBoard: configuration object and canvasId property are mandatory.");if(t=document.getElementById(d.canvasId),u=c(d),t.width=u.canvasWidth,t.height=u.canvasHeight,s=new a.Stage(t),s.scaleX=s.scaleY=s.scale=1,s.regX=u.canvasWidth/2,s.regY=u.canvasHeight/2,s.x=u.canvasWidth/2,s.y=u.canvasHeight/2,s.enableMouseOver(40),s.mouseMoveOutside=!0,s.rotation=0,u.borderSize>0){var m=new a.Container,n=new a.Shape;if(n.graphics.beginStroke(u.borderColor).setStrokeStyle(u.borderSize).drawRect(u.borderSize/2+u.shadowSize+u.boardPaddingWidthSize,u.borderSize/2+u.shadowSize+u.boardPaddingHeightSize,u.allBlocksWidth+u.borderSize,u.allBlocksHeight+u.borderSize),n.shadow=new a.Shadow(u.shadowColor,0,0,15),m.addChild(n),u.coords){var o=new a.Container,p=Math.min(Math.floor(.6*u.borderSize),u.blockSize);e(o,p,"V"),e(o,p,"H"),A.push(o),m.addChild(o)}s.addChild(m)}var q=new a.Container;if(q.regX=u.allBlocksWidth/2,q.regY=u.allBlocksHeight/2,q.x=u.canvasWidth/2,q.y=u.canvasHeight/2,q.scaleX=q.scaleY=q.scale=1,q.name="boardContainer",u.marginBetweenBlocksSize>0){var r=new a.Shape,B=r.graphics;B.beginStroke(u.marginColor).setStrokeStyle(u.marginBetweenBlocksSize);for(var C=0;C<u.blocksInARow-1;C++)B.moveTo(u.blockSize+u.marginBetweenBlocksSize/2+(u.blockSize+u.marginBetweenBlocksSize)*C,0).lineTo(u.blockSize+u.marginBetweenBlocksSize/2+(u.blockSize+u.marginBetweenBlocksSize)*C,u.allBlocksHeight);for(var C=0;C<u.blocksInAColumn-1;C++)B.moveTo(0,u.blockSize+u.marginBetweenBlocksSize/2+(u.blockSize+u.marginBetweenBlocksSize)*C).lineTo(u.allBlocksWidth,u.blockSize+u.marginBetweenBlocksSize/2+(u.blockSize+u.marginBetweenBlocksSize)*C);q.addChild(r)}for(var E=new a.Container,C=0;C<u.blocksInARow*u.blocksInAColumn;C++){var F=C%u.blocksInARow,G=Math.floor(C/u.blocksInARow),H=new a.Shape;H.graphics.beginFill(h(F,G)).drawRect(0,0,u.blockSize,u.blockSize);var I=j(F,G);H.x=I.x,H.y=I.y,H.regY=H.regX=u.blockSize/2,u.actionsOnPieces&&(H.addEventListener("rollover",function(b){if(w){q.removeChild(q.getChildByName("blockHighlighter"));var c=q.globalToLocal(b.stageX,b.stageY),d=k(c.x,c.y),e=new a.Shape;e.graphics.beginStroke(u.highlighterColor).setStrokeStyle(u.highlighterSize).drawRect((u.blockSize+u.marginBetweenBlocksSize)*d.file+u.highlighterSize/2,(u.blockSize+u.marginBetweenBlocksSize)*(u.blocksInAColumn-d.rank-1)+u.highlighterSize/2,u.blockSize-u.highlighterSize,u.blockSize-u.highlighterSize),e.name="blockHighlighter",q.addChildAt(e,q.getNumChildren()-1),x=!0}}.bind(this)),H.addEventListener("rollout",function(a){w&&(q.removeChild(q.getChildByName("blockHighlighter")),x=!0)}.bind(this)),H.addEventListener("pressup",function(a){if(w){q.removeChild(q.getChildByName("blockHighlighter"));var c=q.globalToLocal(a.stageX,a.stageY),d=k(c.x,c.y),e=i(d.file,d.rank),f=this.move(w,e);f||(w.x=w.startPosition.x,w.y=w.startPosition.y),w.scaleX=w.scaleY=w.scale,w.shadow=null,w=b,x=!0}}.bind(this))),"linesGrid"==u.type&&l(H,F,G),E.addChild(H)}q.addChild(E),v=new a.Container,A.push(v),q.addChild(v),s.addChild(q),a.Ticker.addEventListener("tick",function(){var c,d,e,f,g,h,i,k,l,m,n,o,p,q,r=!1,t=!1,v=!1,w=!0,B=!1,C=!1,D=.2*u.rotationDuration,E=.6*u.rotationDuration;return function(F){if(!a.Ticker.getPaused()){if(x&&(x=!1,s.update()),y){if(!r||v)if(w&&(c=u.squeezeScaleFactor),B&&(c=g/s.scaleX),(w||B)&&(f=0,g=s.scaleX,d=s.scaleX*c-s.scaleX,e=d/D,w=!1,B=!1),Math.abs(f)>=Math.abs(d))s.scaleX=s.scaleY=g*c,r||(r=!0,t=!0,C=!0),v&&(v=!1,r=!1,w=!0,y=0);else{var G=F.delta*e;f+=G,s.scaleX=s.scaleY+=G}if(t){if(C){l=0,m=s.rotation,i=y,h=((i+m)%360+360)%360,k=i/E,n=Math.floor((m+45)%360/90),o=Math.floor((h+45)%360/90);var H=0;i>0?(H=(4-(n-o))%4*-90,0==H&&i>=45&&(H=-360)):i<0&&(H=(4+(n-o))%4*90,0==H&&i<-45&&(H=360)),H+=parseInt(i/360,10)*-360,q=H/E,p=(H%360+360)%360;for(var I=0;I<A.length;I++)for(var J=A[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.elementPreviousRotation=L.rotation}C=!1}if(l>=Math.abs(i)){s.rotation=h;for(var I=0;I<A.length;I++)for(var J=A[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);L.rotation=(L.elementPreviousRotation+p)%360,delete L.elementPreviousRotation}v=!0,B=!0,n=0,o=0,t=!1}else{var G=F.delta*k%360;l+=Math.abs(G),s.rotation+=G;for(var I=0;I<A.length;I++)for(var J=A[I],K=0;K<J.getNumChildren();K++){var L=J.getChildAt(K);G=F.delta*q,L.rotation+=G}}}x=!0}if(z.length>0){for(var I=z.length-1;I>=0;I--){var M=z[I],N=j(M.destFile,M.destRank),O=N.x-M.piece.x,P=N.y-M.piece.y;u.animationOfPieces&&(M.piece.file==b&&M.piece.rank==b||(M.piece.file=b,M.piece.rank=b),z[I].piece.x+=.2*O,z[I].piece.y+=.2*P),(!u.animationOfPieces||Math.abs(P)<=1&&Math.abs(O)<=1)&&(M.piece.x=N.x,M.piece.y=N.y,M.piece.file=M.destFile,M.piece.rank=M.destRank,z.splice(I,1))}x=!0}}}}()),a.Ticker.setFPS(40),x=!0,u.position&&this.setPosition(u.position)}.bind(this)()}});